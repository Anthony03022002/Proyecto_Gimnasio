{% extends "base.html" %} {% block title %}Panel Cliente{% endblock %} {% block
content %} {% set active = "cliente_dashboard" %}

<div class="row g-3">
  <div class="col-12 col-lg-9">
    <div
      class="d-lg-none mb-3 d-flex justify-content-between align-items-center"
    >
      <h3 class="mb-0">Panel Cliente</h3>
      <button
        class="btn btn-outline-primary btn-sm"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#menuOffcanvas"
      >
        <i class="bi bi-list"></i> Menú
      </button>
    </div>

    <div class="d-none d-lg-block">
      <h3 class="mb-2">Panel Cliente</h3>
    </div>

    {# ========================= ✅ PLANIFICACIÓN (PDF)
    ========================= #}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div
          class="d-flex justify-content-between align-items-center flex-wrap gap-2"
        >
          <div>
            <h6 class="card-subtitle mb-0 text-muted">Planificación</h6>
            <div class="text-muted small">Enviada por tu entrenador</div>
          </div>

          {% if plan_actual and (plan_actual.filename or plan_actual.rel_path)
          %}
          <a
            class="btn btn-sm btn-primary"
            href="{{ url_for('web.descargar_planificacion', plan_id=plan_actual._id) }}"
          >
            <i class="bi bi-download"></i> Descargar PDF
          </a>
          {% endif %}
        </div>

        <hr class="my-3" />

        {% if plan_actual %}
        <div class="fw-semibold">Plan actual</div>

        <div class="text-muted small">
          {% if plan_actual.filename or plan_actual.rel_path %} {{
          plan_actual.filename }} {% if plan_actual.bytes %} · {{
          (plan_actual.bytes / 1024 / 1024) | round(2) }} MB {% endif %} {% else
          %}
          <span class="text-muted">Sin PDF</span>
          {% endif %}
        </div>

        <div class="text-muted small mt-1">
          {% set dt = plan_actual.updated_at or plan_actual.creado %} {% if dt
          %} Actualizada: {{ dt.strftime('%d/%m/%Y %H:%M') }} {% endif %}
        </div>
        {% else %}
        <div class="text-muted small">
          Aún no tienes una planificación subida por tu entrenador.
        </div>
        {% endif %}
      </div>
    </div>

    <p class="text-muted mb-3">
      Bienvenido{{ (" " ~ (cliente.nombre or "")) if cliente else "" }}.
    </p>

    {# ========================= ALERTAS MEMBRESÍA + BOTÓN RENOVAR (WHATSAPP)
    ========================= #} {% if alertas_membresia and
    alertas_membresia|length > 0 %}
    <div class="mb-3">
      {% for msg in alertas_membresia %}
      <div
        class="alert alert-warning d-flex justify-content-between align-items-center"
        role="alert"
      >
        <div>{{ msg }}</div>

        {% set WHATSAPP_NUM = "593992899479" %} {% set nombre_completo =
        (cliente.nombre or '') ~ ' ' ~ (cliente.apellido or '') %} {% set ident
        = cliente.identificacion or '' %} {% set user = session.get('username')
        or '' %} {% if membresia and membresia.fecha_hasta %} {% set vence_txt =
        membresia.fecha_hasta.strftime('%d/%m/%Y') %} {% else %} {% set
        vence_txt = '-' %} {% endif %} {% set dias_txt = (dias_restantes|string)
        if dias_restantes is not none else '-' %} {% set wa_text = "Hola, quiero
        renovar mi membresía.\n" ~ "Cliente: " ~ nombre_completo|trim ~ "\n" ~
        "Identificación: " ~ ident ~ "\n" ~ "Usuario: " ~ user ~ "\n" ~ "Vence:
        " ~ vence_txt ~ "\n" ~ "Días restantes: " ~ dias_txt %}

        <a
          class="btn btn-sm btn-success"
          target="_blank"
          href="https://wa.me/{{ WHATSAPP_NUM }}?text={{ wa_text|urlencode }}"
        >
          <i class="bi bi-whatsapp"></i> Renovar
        </a>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Mi membresía</h6>

            {% if estado_membresia == "Activa" %}
            <span class="badge text-bg-success">Activa</span>
            {% elif estado_membresia == "Vencida" %}
            <span class="badge text-bg-danger">Vencida</span>
            {% else %}
            <span class="badge text-bg-secondary">Sin membresía</span>
            {% endif %}

            <div class="mt-2 small">
              {% if membresia %}
              <div>
                <b>Desde:</b> {{ membresia.fecha_desde.strftime('%d/%m/%Y') if
                membresia.fecha_desde else '-' }}
              </div>
              <div>
                <b>Hasta:</b> {{ membresia.fecha_hasta.strftime('%d/%m/%Y') if
                membresia.fecha_hasta else '-' }}
              </div>
              <div><b>Meses:</b> {{ membresia.meses or '-' }}</div>
              {% if dias_restantes is not none %}
              <div><b>Días restantes:</b> {{ dias_restantes }}</div>
              {% endif %} {% else %}
              <div class="text-muted">Aún no tienes membresía registrada.</div>
              {% endif %}
            </div>

            {# ✅ BOTÓN RENOVAR (WHATSAPP) DENTRO DE LA CARD #} {% set
            WHATSAPP_NUM = "593992899479" %} {% set nombre_completo =
            (cliente.nombre or '') ~ ' ' ~ (cliente.apellido or '') %} {% set
            ident = cliente.identificacion or '' %} {% set user =
            session.get('username') or '' %} {% if membresia and
            membresia.fecha_hasta %} {% set vence_txt =
            membresia.fecha_hasta.strftime('%d/%m/%Y') %} {% else %} {% set
            vence_txt = '-' %} {% endif %} {% set dias_txt =
            (dias_restantes|string) if dias_restantes is not none else '-' %} {%
            set wa_text = "Hola, quiero renovar mi membresía.\n" ~ "Cliente: " ~
            nombre_completo|trim ~ "\n" ~ "Identificación: " ~ ident ~ "\n" ~
            "Usuario: " ~ user ~ "\n" ~ "Vence: " ~ vence_txt ~ "\n" ~ "Días
            restantes: " ~ dias_txt %}

            <div class="mt-3">
              <a
                class="btn btn-sm btn-success"
                target="_blank"
                href="https://wa.me/{{ WHATSAPP_NUM }}?text={{ wa_text|urlencode }}"
              >
                <i class="bi bi-whatsapp"></i> Renovar
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Mis datos</h6>
            {% if cliente %}
            <div class="small">
              <div><b>Nombre:</b> {{ cliente.nombre or '-' }}</div>
              <div><b>Email:</b> {{ cliente.email or '-' }}</div>
              <div><b>Teléfono:</b> {{ cliente.telefono or '-' }}</div>
            </div>
            {% else %}
            <div class="text-muted small">No hay perfil de cliente.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card shadow-sm">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <span>Horario</span>
            <a
              href="{{ url_for('web.horarios_publico', view='week') }}"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="bi bi-calendar-week"></i> Reservar
            </a>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Entrenador</th>
                    <th class="text-end">Estado</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>

                <tbody>
                  {% if clases_proximas and clases_proximas|length > 0 %} {% for
                  c in clases_proximas %}
                  <tr>
                    <td>
                      {{ c.dt.strftime('%d/%m/%Y') if c.dt else c.fecha_txt }}
                    </td>
                    <td>{{ c.hora }}</td>
                    <td>{{ c.entrenador }}</td>
                    <td class="text-end">
                      <span class="badge text-bg-success">Próxima</span>
                    </td>

                    <td class="text-end">
                      <form
                        method="post"
                        action="{{ url_for('web.cliente_cancelar_reserva', reserva_id=c._id) }}"
                        class="d-inline"
                        onsubmit="return confirm('¿Cancelar esta clase?');"
                      >
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="submit"
                        >
                          <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %} {% endif %} {% if clases_pasadas and
                  clases_pasadas|length > 0 %} {% for c in clases_pasadas %}
                  <tr>
                    <td>
                      {{ c.dt.strftime('%d/%m/%Y') if c.dt else c.fecha_txt }}
                    </td>
                    <td>{{ c.hora }}</td>
                    <td>{{ c.entrenador }}</td>
                    <td class="text-end">
                      <span class="badge text-bg-secondary">Pasada</span>
                    </td>
                    <td class="text-end">-</td>
                  </tr>
                  {% endfor %} {% endif %} {% if (not clases_proximas or
                  clases_proximas|length == 0) and (not clases_pasadas or
                  clases_pasadas|length == 0) %}
                  <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                      Aún no tienes clases reservadas.
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-none d-lg-block col-lg-3">
    {% include "partials/sidebar_admin.html" %}
  </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="menuOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menú</h5>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="offcanvas"
    ></button>
  </div>
  <div class="offcanvas-body">{% include "partials/sidebar_admin.html" %}</div>
</div>

{% endblock %}
