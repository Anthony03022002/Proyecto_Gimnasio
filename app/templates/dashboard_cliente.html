{% extends "base_cliente.html" %}
{% block title %}Panel Cliente{% endblock %}
{% set active = "cliente_dashboard" %}

{% set nombre_cliente = ((cliente.nombre or '') ~ ' ' ~ (cliente.apellido or ''))|trim if cliente else (session.get('username') or 'Cliente') %}
{% set estado = estado_membresia or "Sin membresía" %}
{% set dias = dias_restantes if dias_restantes is not none else None %}

{% set WHATSAPP_NUM = "593992899479" %}
{% set ident = cliente.identificacion or '' if cliente else '' %}
{% set user = session.get('username') or '' %}
{% if membresia and membresia.fecha_hasta %}
  {% set vence_txt = membresia.fecha_hasta.strftime('%d/%m/%Y') %}
{% else %}
  {% set vence_txt = '-' %}
{% endif %}
{% set dias_txt = (dias_restantes|string) if dias_restantes is not none else '-' %}
{% set wa_text = "Hola, quiero renovar mi membresía.\n" ~
  "Cliente: " ~ nombre_cliente ~ "\n" ~
  "Identificación: " ~ ident ~ "\n" ~
  "Usuario: " ~ user ~ "\n" ~
  "Vence: " ~ vence_txt ~ "\n" ~
  "Días restantes: " ~ dias_txt
%}

{% block header_title %}{{ nombre_cliente }}{% endblock %}

{% block header_actions %}
  <a href="{{ url_for('web.horarios_publico', view='week') }}"
     class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10
            text-white font-semibold text-sm transition flex items-center gap-2">
    <span class="material-symbols-outlined text-[18px]">calendar_month</span>
    Reservar
  </a>
{% endblock %}

{% block content %}
<style>
  /* Solo afecta a este dashboard */
  .elite-soft-card{
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 18px 50px rgba(0,0,0,0.35);
  }
  .elite-soft-card:hover{
    border-color: rgba(255,255,255,0.12);
  }
  .elite-divider{ border-color: rgba(255,255,255,0.08); }
  .elite-muted{ color: rgba(255,255,255,0.55); }
  .elite-pill{
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.15);
  }
  .elite-btn{
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.06);
  }
  .elite-btn:hover{ background: rgba(255,255,255,0.10); }
  .elite-btn-danger{
    border: 1px solid rgba(255,80,80,0.35);
    background: rgba(255,80,80,0.08);
  }
  .elite-btn-danger:hover{ background: rgba(255,80,80,0.12); }
</style>

<div class="space-y-8">

  {# ALERTAS #}
  {% if alertas_membresia and alertas_membresia|length > 0 %}
    <div class="space-y-2">
      {% for msg in alertas_membresia %}
        <div class="elite-soft-card rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="text-sm text-white/90">
            <span class="font-semibold">Aviso:</span> <span class="elite-muted">{{ msg }}</span>
          </div>
          <a target="_blank"
             href="https://wa.me/{{ WHATSAPP_NUM }}?text={{ wa_text|urlencode }}"
             class="elite-btn px-4 py-2 rounded-lg text-white font-semibold text-sm transition flex items-center gap-2">
            <span class="material-symbols-outlined text-[18px]">chat</span>
            Renovar
          </a>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# HERO #}
  <div class="relative rounded-3xl overflow-hidden min-h-[200px] md:min-h-[220px] elite-soft-card">
    <img class="absolute inset-0 w-full h-full object-cover opacity-50"
         src="https://lh3.googleusercontent.com/aida-public/AB6AXuDBHUxRDHF8aLnkJWF__FXQiznlb_DyP8MqdvCpYrpXsDSwtWESlQAOfgFDs2pfRZHG1YplsRdZiVIZRJ-pQGYuAgTqUWvshtx3nDplNSOJitv7vF815ZwBt_9fRjCvj6tv6sTQQhvYd36MN6Y8nxy250Do5lVjuvfCTQEnG7dlBYYXP8QwRq3PGMjq7iRXebtZMP9FoByqL7Qtvuo8PmRsu6EcZGNEXccoRlFw7yh703x6z8sl3J_FkYicHJbfC7dRL6ChfPcQbH6C"
         alt="Hero"/>

    <div class="absolute inset-0 bg-gradient-to-r from-black/70 via-black/45 to-transparent"></div>

    <div class="relative z-10 p-7 md:p-10 max-w-3xl">
      <h2 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">
        FORJA TU INTERIOR
      </h2>
      <p class="mt-3 text-base md:text-lg elite-muted max-w-xl">
        Tu excelencia comienza hoy. Revisa tu estado, descarga tu planificación y gestiona tus reservas.
      </p>

      <div class="mt-6 flex flex-wrap gap-2">
        <a href="{{ url_for('web.horarios_publico', view='week') }}"
           class="elite-btn px-4 py-2 rounded-lg text-white font-semibold text-sm transition">
          Ver horarios
        </a>

        {% if plan_actual and (plan_actual.filename or plan_actual.rel_path) %}
          <a href="{{ url_for('web.descargar_planificacion', plan_id=plan_actual._id) }}"
             class="elite-btn px-4 py-2 rounded-lg text-white font-semibold text-sm transition">
            Descargar PDF
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  {# GRID PRINCIPAL #}
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

    {# IZQUIERDA #}
    <div class="lg:col-span-4 space-y-6">

      {# MEMBRESÍA #}
      <div class="elite-soft-card rounded-2xl p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-white font-semibold text-lg">Membresía</div>
            <div class="text-xs elite-muted mt-1">
              {{ (membresia.meses ~ " mes(es)") if membresia and membresia.meses else "Sin plan" }}
            </div>
          </div>

          {% if estado == "Activa" %}
            <span class="elite-pill px-3 py-1 rounded-lg text-xs font-bold text-white/90 uppercase">Activa</span>
          {% elif estado == "Vencida" %}
            <span class="elite-pill px-3 py-1 rounded-lg text-xs font-bold text-white/90 uppercase">Vencida</span>
          {% else %}
            <span class="elite-pill px-3 py-1 rounded-lg text-xs font-bold text-white/70 uppercase">Sin membresía</span>
          {% endif %}
        </div>

        <div class="mt-5 space-y-3 text-sm">
          <div class="flex justify-between items-center border-b elite-divider pb-2">
            <span class="elite-muted uppercase text-xs tracking-widest">Vence</span>
            <span class="text-white font-semibold">
              {{ membresia.fecha_hasta.strftime('%d/%m/%Y') if membresia and membresia.fecha_hasta else '-' }}
            </span>
          </div>
          <div class="flex justify-between items-center border-b elite-divider pb-2">
            <span class="elite-muted uppercase text-xs tracking-widest">Inicio</span>
            <span class="text-white font-semibold">
              {{ membresia.fecha_desde.strftime('%d/%m/%Y') if membresia and membresia.fecha_desde else '-' }}
            </span>
          </div>
          <div class="flex justify-between items-center">
            <span class="elite-muted uppercase text-xs tracking-widest">Días restantes</span>
            <span class="text-white font-extrabold text-base">
              {{ dias if dias is not none else '--' }}
            </span>
          </div>
        </div>

        <a target="_blank"
           href="https://wa.me/{{ WHATSAPP_NUM }}?text={{ wa_text|urlencode }}"
           class="mt-5 w-full elite-btn px-4 py-3 rounded-lg text-white font-bold text-sm uppercase tracking-widest transition flex items-center justify-center gap-2">
          <span class="material-symbols-outlined text-[18px]">workspace_premium</span>
          Renovar privilegios
        </a>
      </div>

      {# MIS DATOS #}
      <div class="elite-soft-card rounded-2xl p-6">
        <div class="text-white font-semibold text-lg">Mis datos</div>

        <div class="mt-4 space-y-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center">
              <span class="material-symbols-outlined text-white/80">alternate_email</span>
            </div>
            <div>
              <div class="text-xs elite-muted uppercase tracking-widest">E-mail</div>
              <div class="text-white font-semibold">{{ cliente.email or '-' if cliente else '-' }}</div>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center">
              <span class="material-symbols-outlined text-white/80">phone_iphone</span>
            </div>
            <div>
              <div class="text-xs elite-muted uppercase tracking-widest">Contacto</div>
              <div class="text-white font-semibold">{{ cliente.telefono or '-' if cliente else '-' }}</div>
            </div>
          </div>
        </div>

        <a href="{{ url_for('web.cliente_config') }}"
           class="mt-5 inline-flex w-full justify-center elite-btn px-4 py-3 rounded-lg text-white font-semibold text-sm transition">
          Editar información
        </a>
      </div>

    </div>

    {# DERECHA #}
    <div class="lg:col-span-8 space-y-6">

      {# PLANIFICACIÓN #}
      <div class="elite-soft-card rounded-2xl p-6 md:p-8">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-white font-semibold text-2xl">Planificación</div>
            <p class="mt-2 elite-muted">
              {% if plan_actual and (plan_actual.filename or plan_actual.rel_path) %}
                Tu planificación ya está lista. Descárgala y síguela.
              {% else %}
                Tu entrenador está preparando tu próxima ruta. Te avisaremos cuando tu plan esté listo.
              {% endif %}
            </p>
          </div>
          <div class="opacity-20">
            <span class="material-symbols-outlined text-[64px]">military_tech</span>
          </div>
        </div>

        {% if plan_actual and (plan_actual.filename or plan_actual.rel_path) %}
          <div class="mt-5 flex flex-wrap gap-2">
            <a href="{{ url_for('web.descargar_planificacion', plan_id=plan_actual._id) }}"
               class="elite-btn px-4 py-2 rounded-lg text-white font-semibold text-sm transition inline-flex items-center gap-2">
              <span class="material-symbols-outlined text-[18px]">download</span>
              Descargar PDF
            </a>
          </div>

          <div class="mt-3 text-xs elite-muted">
            {% set dt = plan_actual.updated_at or plan_actual.creado %}
            {% if dt %}Actualizada: {{ dt.strftime('%d/%m/%Y %H:%M') }}{% endif %}
          </div>
        {% endif %}
      </div>

      {# PRÓXIMAS RESERVAS #}
      <div class="elite-soft-card rounded-2xl p-6 md:p-8">
        <div class="flex items-end justify-between gap-4">
          {% if puede_no_asistir %}
          <form method="post"
                action="{{ url_for('web.cliente_no_podre_asistir_manana') }}"
                onsubmit="return confirm('¿Confirmas que no podrás asistir a la clase de mañana?');"
                class="mt-4">
            <button type="submit"
                    class="elite-btn px-4 py-3 rounded-lg text-white font-bold text-sm uppercase tracking-widest transition w-full md:w-auto">
              No podré asistir mañana
            </button>
          </form>
        {% elif reserva_manana and reserva_manana.no_asistire %}
          <div class="mt-4 elite-pill px-4 py-3 rounded-lg text-white/80 text-sm font-semibold">
            Ya notificaste que no podrás asistir mañana.
          </div>
        {% endif %}

          <div>
            <div class="text-white font-semibold text-xl">Próximas reservas</div>
            <div class="text-xs elite-muted uppercase tracking-widest mt-1">Tu agenda</div>
          </div>
          <a href="{{ url_for('web.horarios_publico', view='week') }}"
             class="text-sm text-white/80 hover:text-white font-semibold transition inline-flex items-center gap-2">
            Calendario completo
            <span class="material-symbols-outlined text-[18px]">arrow_forward_ios</span>
          </a>
        </div>

        <div class="mt-5 space-y-3">
          {% if clases_proximas and clases_proximas|length > 0 %}
            {% for c in clases_proximas[:4] %}
              <div class="rounded-xl bg-white/3 border border-white/8 px-4 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div class="flex items-start gap-4">
                  <span class="elite-pill px-3 py-1 rounded-lg text-[11px] font-bold uppercase">
                    Próxima
                  </span>

                  <div>
                    <div class="text-white font-extrabold text-xl leading-none">{{ c.hora }}</div>
                    <div class="text-sm elite-muted mt-1">
                      {{ c.dt.strftime('%d/%m/%Y') if c.dt else c.fecha_txt }} · Entrenador:
                      <span class="text-white font-semibold">{{ c.entrenador }}</span>
                    </div>
                  </div>
                </div>

                <form method="post"
                      action="{{ url_for('web.cliente_cancelar_reserva', reserva_id=c._id) }}"
                      onsubmit="return confirm('¿Cancelar esta clase?');">
                  <button type="submit"
                          class="elite-btn-danger px-4 py-2 rounded-lg text-white font-bold text-sm uppercase tracking-widest transition">
                    Cancelar
                  </button>
                </form>
              </div>
            {% endfor %}
          {% else %}
            <div class="rounded-2xl border border-dashed border-white/12 p-8 text-center">
              <div class="w-12 h-12 rounded-full bg-white/5 border border-white/10 mx-auto flex items-center justify-center">
                <span class="material-symbols-outlined text-white/40">event_busy</span>
              </div>
              <div class="mt-4 text-white font-semibold">Sin reservas activas</div>
              <div class="mt-1 elite-muted text-sm">Explora los horarios disponibles</div>
              <a href="{{ url_for('web.horarios_publico', view='week') }}"
                 class="mt-4 inline-flex elite-btn px-5 py-2 rounded-lg text-white font-semibold text-sm transition">
                Ver horarios
              </a>
            </div>
          {% endif %}
        </div>
      </div>

      {# BOTONES RÁPIDOS (más sobrios para que calcen con el menú) #}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
        <a href="{{ url_for('web.horarios_publico', view='week') }}"
           class="elite-soft-card rounded-2xl p-6 transition hover:translate-y-[-1px]">
          <div class="w-12 h-12 bg-white/5 border border-white/10 rounded-xl flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-white/80 text-2xl">calendar_month</span>
          </div>
          <div class="text-white font-semibold">Horario</div>
          <div class="text-sm elite-muted mt-1">Reserva y gestiona tus clases.</div>
        </a>

        <a href="{{ url_for('web.cliente_progreso') }}"
           class="elite-soft-card rounded-2xl p-6 transition hover:translate-y-[-1px]">
          <div class="w-12 h-12 bg-white/5 border border-white/10 rounded-xl flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-white/80 text-2xl">monitoring</span>
          </div>
          <div class="text-white font-semibold">Progreso</div>
          <div class="text-sm elite-muted mt-1">Tu avance y estadísticas.</div>
        </a>

        <a href="{{ url_for('web.cliente_membresia') }}"
           class="elite-soft-card rounded-2xl p-6 transition hover:translate-y-[-1px]">
          <div class="w-12 h-12 bg-white/5 border border-white/10 rounded-xl flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-white/80 text-2xl">workspace_premium</span>
          </div>
          <div class="text-white font-semibold">Membresía</div>
          <div class="text-sm elite-muted mt-1">Estado y renovación.</div>
        </a>
      </div>

    </div>
  </div>
</div>
{% endblock %}
