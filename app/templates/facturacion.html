{% extends "base_admin.html" %}
{% block title %}Nueva venta{% endblock %}

{% block header %}
<header class="h-20 bg-surface-dark/50 backdrop-blur-md px-5 md:px-8 flex items-center justify-between sticky top-0 z-10 border-b border-white/5">
  <div class="flex items-center gap-3">
    <button
      type="button"
      class="md:hidden p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
      onclick="openDrawer()"
      aria-label="Abrir menú"
    >
      <span class="material-symbols-outlined">menu</span>
    </button>

    <div>
      <h2 class="text-xl md:text-2xl font-bold text-white">Nueva venta</h2>
      <p class="text-xs text-[rgba(255,255,255,0.6)] mt-1">
        Registra una nueva venta y crea/actualiza la membresía del cliente.
      </p>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
{% set active = "facturacion_nueva" %}

<div class="max-w-6xl mx-auto px-6 md:px-8 py-6 space-y-6">
  <form method="post" action="{{ url_for('web.facturacion_nueva_post') }}" class="space-y-6">

    <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
      <div class="p-6 border-b border-[rgba(255,255,255,0.07)] flex items-center justify-between">
        <h3 class="text-lg font-bold text-white">Datos del cliente</h3>
        <span class="text-xs text-[rgba(255,255,255,0.45)]">Completa la información básica</span>
      </div>

      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">

          {# 1ra fila (3 inputs) #}
          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Identificación (Cédula/RUC)</label>
            <input
              type="text"
              name="identificacion"
              required
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Nombre</label>
            <input
              type="text"
              name="nombre"
              required
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Apellido</label>
            <input
              type="text"
              name="apellido"
              required
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Email</label>
            <input
              type="email"
              name="email"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Teléfono</label>
            <input
              type="text"
              name="telefono"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Fecha de nacimiento</label>
            <input
              type="date"
              name="fecha_nacimiento"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          {# ✅ 3ra fila (3 inputs) - NUEVOS #}
          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Nickname</label>
            <input
              type="text"
              name="nickname"
              placeholder="Ej: Tony"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Sexo</label>
            <select
              name="sexo"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            >
              <option class="text-black" value="">-- Seleccione --</option>
              <option class="text-black" value="M">Masculino</option>
              <option class="text-black" value="F">Femenino</option>
              <option class="text-black" value="O">Otro</option>
            </select>
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Contacto de emergencia (Nombre)</label>
            <input
              type="text"
              name="contacto_emergencia_nombre"
              placeholder="Ej: María Pérez"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

          <div class="md:col-span-4">
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Contacto de emergencia (Teléfono)</label>
            <input
              type="text"
              name="contacto_emergencia_numero"
              placeholder="Ej: 0999999999"
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>

        </div>
      </div>
    </div>

    <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
      <div class="p-6 border-b border-[rgba(255,255,255,0.07)] flex items-center justify-between">
        <h3 class="text-lg font-bold text-white">Detalle</h3>
        <span class="text-xs text-[rgba(255,255,255,0.45)]">Descripción de la venta</span>
      </div>

      <div class="p-6">
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Descripción</label>
            <input
              type="text"
              name="descripcion"
              placeholder="Ej: Mensualidad gimnasio"
              required
              class="mt-1 w-full px-4 py-2.5 rounded-xl
                     bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                     text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                     outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            />
          </div>
        </div>

        <div class="mt-6 border border-[rgba(255,255,255,0.07)] rounded-2xl overflow-hidden">
          <div class="px-6 py-4 bg-[rgba(255,255,255,0.05)] border-b border-[rgba(255,255,255,0.07)]">
            <h4 class="text-sm font-bold text-white">Membresía</h4>
            <p class="text-xs text-[rgba(255,255,255,0.45)] mt-1">Define meses y rango de fechas</p>
          </div>

          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">

              <div class="md:col-span-4">
                <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Meses</label>
                <select
                  name="meses"
                  id="meses"
                  required
                  class="mt-1 w-full px-4 py-2.5 rounded-xl
                         bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                         text-[rgba(255,255,255,0.92)]
                         outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                >
                  {% for m in range(1, 13) %}
                    <option class="text-black" value="{{ m }}">{{ m }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="md:col-span-4">
                <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Fecha desde</label>
                <input
                  type="date"
                  name="fecha_desde"
                  id="fecha_desde"
                  required
                  class="mt-1 w-full px-4 py-2.5 rounded-xl
                         bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                         text-[rgba(255,255,255,0.92)]
                         outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                />
              </div>

              <div class="md:col-span-4">
                <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Fecha hasta</label>
                <input
                  type="date"
                  name="fecha_hasta"
                  id="fecha_hasta"
                  required
                  class="mt-1 w-full px-4 py-2.5 rounded-xl
                         bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                         text-[rgba(255,255,255,0.92)]
                         outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                />
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="flex flex-wrap justify-end gap-2">
      <a
        href="{{ url_for('web.admin_dashboard') }}"
        class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-[rgba(255,255,255,0.06)]
               text-sm font-semibold text-white/90 transition-colors"
      >
        Cancelar
      </a>

      <button
        type="submit"
        class="px-4 py-2 rounded-lg bg-accent hover:bg-accent/90
               text-sm font-semibold text-white transition-colors"
      >
        Guardar venta
      </button>
    </div>

  </form>
</div>

{% endblock %}

{% block scripts %}
<script>
  (function () {
    const mesesSel = document.getElementById("meses");
    const desdeInp = document.getElementById("fecha_desde");
    const hastaInp = document.getElementById("fecha_hasta");

    if (!mesesSel || !desdeInp || !hastaInp) return;

    function pad2(n) { return String(n).padStart(2, "0"); }

    function hoyISO() {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }

    function parseISODate(s) {
      if (!s) return null;
      const [y, m, d] = s.split("-").map(Number);
      if (!y || !m || !d) return null;
      return { y, m, d };
    }

    function lastDayOfMonth(y, m) {
      return new Date(y, m, 0).getDate();
    }

    function addMonthsISO(iso, months) {
      const p = parseISODate(iso);
      if (!p) return "";
      let y = p.y, m = p.m, d = p.d;

      let total = (m - 1) + months;
      y = y + Math.floor(total / 12);
      m = (total % 12) + 1;

      const last = lastDayOfMonth(y, m);
      const day = Math.min(d, last);

      return `${y}-${pad2(m)}-${pad2(day)}`;
    }

    function recalc() {
      const meses = parseInt(mesesSel.value || "0", 10) || 0;

      if (!desdeInp.value) {
        desdeInp.value = hoyISO();
      }

      if (meses > 0) {
        hastaInp.value = addMonthsISO(desdeInp.value, meses);
      } else {
        hastaInp.value = "";
      }
    }

    mesesSel.addEventListener("change", recalc);

    desdeInp.addEventListener("change", recalc);

    recalc();
  })();
</script>
{% endblock %}
