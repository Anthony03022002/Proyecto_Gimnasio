{% extends "base_admin.html" %}
{% block title %}CORE Gym - Panel Administrador{% endblock %}
{% set active = "admin_dashboard" %}

{% block header %}
  {% set role = session.get("user_role") %}
  {% set username = session.get("username") or "Usuario" %}
  {% set noti_count = (clientes_por_vencer|length) if clientes_por_vencer is defined and clientes_por_vencer else 0 %}

  <header class="h-20 bg-surface-dark/50 backdrop-blur-md px-5 md:px-8 flex items-center justify-between sticky top-0 z-10 border-b border-white/5">
    <div class="flex items-center gap-3">
      <button
        type="button"
        class="md:hidden p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
        onclick="openDrawer()"
        aria-label="Abrir menú"
      >
        <span class="material-symbols-outlined">menu</span>
      </button>

      <div>
        <h2 class="text-xl md:text-2xl font-bold text-white">Administrador</h2>
      </div>
    </div>

    <div class="flex items-center gap-4 md:gap-6">
      <button
        type="button"
        class="relative p-2 text-secondary hover:text-white hover:bg-white/5 rounded-full transition-colors"
        onclick="openNotiModal()"
        aria-label="Notificaciones"
        title="Notificaciones de renovaciones"
      >
        <span class="material-symbols-outlined">notifications</span>

        {% if noti_count > 0 %}
          <span class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] px-1 bg-red-500 rounded-full text-[10px] font-bold flex items-center justify-center border-2 border-surface-dark">
            {{ noti_count }}
          </span>
        {% endif %}
      </button>

      <div class="hidden md:block h-8 w-[1px] bg-white/10"></div>

      <div class="flex items-center gap-3">
        <div class="text-right hidden sm:block">
          <p class="text-sm font-semibold text-white leading-tight">{{ username }}</p>
          <p class="text-xs text-secondary">Administrador</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white font-medium border border-white/10">
          {{ (username[:1] or "U")|upper }}{{ (username[1:2] or "")|upper }}
        </div>
      </div>
    </div>
  </header>
{% endblock %}

{% block content %}

  {# KPI cards #}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">person_outline</span>
        </div>
        <span class="text-[10px] font-bold text-green-400 bg-green-400/10 px-2 py-1 rounded-full uppercase tracking-wider">OK</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Clientes</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ total_clientes }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Registrados en el sistema</p>
    </div>

    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">exercise</span>
        </div>
        <span class="text-[10px] font-bold text-secondary bg-white/5 px-2 py-1 rounded-full uppercase tracking-wider">Staff</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Entrenadores</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ total_entrenadores }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Activos actualmente</p>
    </div>

    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">trending_up</span>
        </div>
        <span class="text-[10px] font-bold text-red-400 bg-red-400/10 px-2 py-1 rounded-full uppercase tracking-wider">Hoy</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Ventas hoy</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ ventas_hoy }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Registros creados hoy</p>
    </div>

    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">badge</span>
        </div>
        <span class="text-[10px] font-bold text-secondary bg-white/5 px-2 py-1 rounded-full uppercase tracking-wider">Staff</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Cajeros</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ total_cajeros }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Usuarios con rol cajero</p>
    </div>
  </div>

  {# Tabla “Próximas clases” (manteniendo tu lógica) #}
  <div class="bg-surface-dark rounded-2xl shadow-sm border border-white/5 overflow-hidden">
    <div class="p-6 border-b border-white/5 flex items-center justify-between">
      <h3 class="text-lg font-bold text-white">Próximas clases</h3>

      <a
        href="{{ url_for('web.admin_horarios') }}"
        class="text-sm font-semibold text-accent hover:text-white flex items-center gap-2 transition-colors"
      >
        Ver horarios <span class="material-symbols-outlined text-sm">arrow_forward</span>
      </a>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left">
        <thead class="bg-white/5">
          <tr>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Cliente</th>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Meses</th>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Desde</th>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider text-right">Hasta</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-white/5">
          {% if ultimas_ventas %}
            {% for v in ultimas_ventas %}
              <tr class="hover:bg-white/[0.03] transition-colors">
                <td class="px-6 py-4 text-sm text-white font-medium">{{ v.cliente_nombre or '-' }}</td>
                <td class="px-6 py-4 text-sm text-secondary">{{ v.membresia.meses or '-' }}</td>
                <td class="px-6 py-4 text-sm text-secondary">
                  {% if v.membresia and v.membresia.fecha_desde %}
                    {{ v.membresia.fecha_desde.strftime('%d/%m/%Y') }}
                  {% else %}-{% endif %}
                </td>
                <td class="px-6 py-4 text-sm text-secondary text-right">
                  {% if v.membresia and v.membresia.fecha_hasta %}
                    {{ v.membresia.fecha_hasta.strftime('%d/%m/%Y') }}
                  {% else %}-{% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td class="px-6 py-20 text-center" colspan="4">
                <div class="flex flex-col items-center justify-center text-secondary/40">
                  <span class="material-symbols-outlined text-5xl mb-3">inventory_2</span>
                  <p class="text-sm font-medium">Aún no hay ventas registradas o clases próximas.</p>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {# MODAL Notificaciones (Tailwind) #}
  {% set noti_count = (clientes_por_vencer|length) if clientes_por_vencer is defined and clientes_por_vencer else 0 %}

  <div id="notiModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/60" onclick="closeNotiModal()"></div>

    <div class="relative mx-auto mt-10 w-[95vw] max-w-5xl bg-surface-dark border border-white/10 rounded-2xl overflow-hidden shadow-2xl">
      <div class="p-5 md:p-6 border-b border-white/10 flex items-start justify-between gap-4">
        <div>
          <h4 class="text-lg font-bold text-white">Clientes por renovar / no renovaron</h4>
        </div>

        <button
          type="button"
          class="p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
          onclick="closeNotiModal()"
          aria-label="Cerrar"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="p-5 md:p-6">
        {% if clientes_por_vencer and clientes_por_vencer|length > 0 %}
          <div class="overflow-x-auto rounded-xl border border-white/10">
            <table class="w-full text-left">
              <thead class="bg-white/5">
                <tr>
                  <th class="px-5 py-3 text-xs font-bold text-accent uppercase tracking-wider">Cliente</th>
                  <th class="px-5 py-3 text-xs font-bold text-accent uppercase tracking-wider">Cédula</th>
                  <th class="px-5 py-3 text-xs font-bold text-accent uppercase tracking-wider">Teléfono</th>
                  <th class="px-5 py-3 text-xs font-bold text-accent uppercase tracking-wider">Email</th>
                  <th class="px-5 py-3 text-xs font-bold text-accent uppercase tracking-wider text-right">Estado</th>
                </tr>
              </thead>

              <tbody class="divide-y divide-white/10">
                {% for c in clientes_por_vencer %}
                  <tr class="hover:bg-white/[0.03] transition-colors">
                    <td class="px-5 py-4 text-sm text-white font-semibold">{{ c.nombre or '-' }}</td>
                    <td class="px-5 py-4 text-sm text-secondary">{{ c.identificacion or '-' }}</td>
                    <td class="px-5 py-4 text-sm text-secondary">{{ c.telefono or '-' }}</td>
                    <td class="px-5 py-4 text-sm text-secondary">{{ c.email or '-' }}</td>

                    <td class="px-5 py-4 text-right">
                      {% if c.no_renovo %}
                        <span class="inline-flex items-center gap-2 text-[11px] font-bold text-red-300 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">
                          NO RENOVÓ (hace {{ (c.dias_restantes * -1) }} día(s))
                        </span>
                      {% else %}
                        {% if c.dias_restantes == 0 %}
                          <span class="inline-flex items-center gap-2 text-[11px] font-bold text-red-300 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">
                            VENCE HOY
                          </span>
                        {% elif c.dias_restantes == 1 %}
                          <span class="inline-flex items-center gap-2 text-[11px] font-bold text-yellow-200 bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20">
                            VENCE EN 1 DÍA
                          </span>
                        {% elif c.dias_restantes == 2 %}
                          <span class="inline-flex items-center gap-2 text-[11px] font-bold text-yellow-200 bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20">
                            VENCE EN 2 DÍAS
                          </span>
                        {% else %}
                          <span class="inline-flex items-center gap-2 text-[11px] font-bold text-secondary bg-white/5 px-3 py-1 rounded-full border border-white/10">
                            {{ c.dias_restantes }} día(s)
                          </span>
                        {% endif %}
                      {% endif %}

                      {% if c.fecha_hasta %}
                        <div class="text-xs text-secondary mt-1">Hasta: {{ c.fecha_hasta }}</div>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-sm text-secondary">
            No hay clientes por renovar (ni vencidos sin renovación) en este momento.
          </div>
        {% endif %}
      </div>

      <div class="p-5 md:p-6 border-t border-white/10 flex justify-end">
        <button
          type="button"
          class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm font-semibold text-white transition-colors"
          onclick="closeNotiModal()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
  function openNotiModal() {
    const m = document.getElementById("notiModal");
    if (!m) return;
    m.classList.remove("hidden");
    m.setAttribute("aria-hidden","false");
  }

  function closeNotiModal() {
    const m = document.getElementById("notiModal");
    if (!m) return;
    m.classList.add("hidden");
    m.setAttribute("aria-hidden","true");
  }

  (function () {
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeNotiModal();
    });
  })();
</script>
{% endblock %}
