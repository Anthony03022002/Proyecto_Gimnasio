{% extends "base_admin.html" %}
{% block title %}CORE Functional Gym{% endblock %}
{% set active = "admin_dashboard" %}

{% block header %}
  {% set role = session.get("user_role") %}
  {% set username = session.get("username") or "Usuario" %}
  {# ‚úÖ Badge toma TODAS las notificaciones (cumplea√±os + renovaciones) #}
  {% set noti_count = (notificaciones|length) if notificaciones is defined and notificaciones else 0 %}

  <style>
    .noti-modal-panel{
      max-height: 88vh;      
      display: flex;
      flex-direction: column;
    }

    .noti-modal-body{
      flex: 1 1 auto;
      min-height: 0;            
    }
    .noti-body{
      flex: 1 1 auto;
      min-height: 0; 
      display: flex;
      flex-direction: column;
    }
    .noti-scroll{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .noti-modal-scroll{
      max-height: 50vh;         
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 640px){
      .noti-modal-panel{ max-height: 92vh; }
      .noti-modal-scroll{ max-height: 68vh; }
    }
  </style>

  <header class="h-20 bg-surface-dark/50 backdrop-blur-md px-5 md:px-8 flex items-center justify-between sticky top-0 z-10 border-b border-white/5">
    <div class="flex items-center gap-3">
      <button
        type="button"
        class="md:hidden p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
        onclick="openDrawer()"
        aria-label="Abrir men√∫"
      >
        <span class="material-symbols-outlined">menu</span>
      </button>

      <div>
        <h2 class="text-xl md:text-2xl font-bold text-white">Administrador</h2>
      </div>
    </div>

    <div class="flex items-center gap-4 md:gap-6">
      <button
        type="button"
        class="relative p-2 text-secondary hover:text-white hover:bg-white/5 rounded-full transition-colors"
        onclick="openNotiModal()"
        aria-label="Notificaciones"
        title="Notificaciones"
      >
        <span class="material-symbols-outlined">notifications</span>

        {% if noti_count > 0 %}
          <span id="notiBadge"
                class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] px-1 bg-red-500 rounded-full text-[10px] font-bold flex items-center justify-center border-2 border-surface-dark">
            {{ noti_count }}
          </span>
        {% endif %}
      </button>

      <div class="hidden md:block h-8 w-[1px] bg-white/10"></div>

      <div class="flex items-center gap-3">
        <div class="text-right hidden sm:block">
          <p class="text-sm font-semibold text-white leading-tight">{{ username }}</p>
          <p class="text-xs text-secondary">Administrador</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white font-medium border border-white/10">
          {{ (username[:1] or "U")|upper }}{{ (username[1:2] or "")|upper }}
        </div>
      </div>
    </div>
  </header>
{% endblock %}

{% block content %}

  {# KPI cards #}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">person_outline</span>
        </div>
        <span class="text-[10px] font-bold text-green-400 bg-green-400/10 px-2 py-1 rounded-full uppercase tracking-wider">OK</span>
      </div>

      <h3 class="text-secondary text-sm font-medium">Clientes</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ total_clientes }}</p>

      <div class="mt-3 flex items-center justify-between text-[11px]">
        <span class="text-secondary font-medium">Registrados en el sistema</span>
        <span class="px-2 py-1 rounded-full bg-white/5 text-white/90 font-semibold">
          Activos: {{ clientes_activos }}
        </span>
      </div>
    </div>


    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">exercise</span>
        </div>
        <span class="text-[10px] font-bold text-secondary bg-white/5 px-2 py-1 rounded-full uppercase tracking-wider">Staff</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Entrenadores</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ total_entrenadores }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Activos actualmente</p>
    </div>

    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">trending_up</span>
        </div>
        <span class="text-[10px] font-bold text-red-400 bg-red-400/10 px-2 py-1 rounded-full uppercase tracking-wider">Hoy</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Ventas hoy</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ ventas_hoy }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Registros creados hoy</p>
    </div>

    <div class="bg-surface-dark p-6 rounded-2xl shadow-sm border border-white/5 transition-transform hover:-translate-y-1">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-white/5 rounded-xl">
          <span class="material-symbols-outlined text-accent">badge</span>
        </div>
        <span class="text-[10px] font-bold text-secondary bg-white/5 px-2 py-1 rounded-full uppercase tracking-wider">Staff</span>
      </div>
      <h3 class="text-secondary text-sm font-medium">Cajeros</h3>
      <p class="text-3xl font-bold text-white mt-1">{{ total_cajeros }}</p>
      <p class="text-[11px] text-secondary mt-2 font-medium">Usuarios con rol cajero</p>
    </div>
  </div>

  {# Tabla ‚ÄúPr√≥ximas clases‚Äù #}
  <div class="bg-surface-dark rounded-2xl shadow-sm border border-white/5 overflow-hidden mt-6">
    <div class="p-6 border-b border-white/5 flex items-center justify-between">
      <h3 class="text-lg font-bold text-white">Pr√≥ximas clases</h3>

      <a
        href="{{ url_for('web.admin_horarios') }}"
        class="text-sm font-semibold text-accent hover:text-white flex items-center gap-2 transition-colors"
      >
        Ver horarios <span class="material-symbols-outlined text-sm">arrow_forward</span>
      </a>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left">
        <thead class="bg-white/5">
          <tr>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Cliente</th>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Meses</th>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Desde</th>
            <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider text-right">Hasta</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-white/5">
          {% if ultimas_ventas %}
            {% for v in ultimas_ventas %}
              <tr class="hover:bg-white/[0.03] transition-colors">
                <td class="px-6 py-4 text-sm text-white font-medium">{{ v.cliente_nombre or '-' }}</td>
                <td class="px-6 py-4 text-sm text-secondary">{{ v.membresia.meses or '-' }}</td>
                <td class="px-6 py-4 text-sm text-secondary">
                  {% if v.membresia and v.membresia.fecha_desde %}
                    {{ v.membresia.fecha_desde.strftime('%d/%m/%Y') }}
                  {% else %}-{% endif %}
                </td>
                <td class="px-6 py-4 text-sm text-secondary text-right">
                  {% if v.membresia and v.membresia.fecha_hasta %}
                    {{ v.membresia.fecha_hasta.strftime('%d/%m/%Y') }}
                  {% else %}-{% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td class="px-6 py-20 text-center" colspan="4">
                <div class="flex flex-col items-center justify-center text-secondary/40">
                  <span class="material-symbols-outlined text-5xl mb-3">inventory_2</span>
                  <p class="text-sm font-medium">A√∫n no hay ventas registradas o clases pr√≥ximas.</p>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {# =========================
     MODAL Notificaciones
     ========================= #}
  {# ‚úÖ NO volver a redefinir noti_count con clientes_por_vencer #}
  {% set noti_count = (notificaciones|length) if notificaciones is defined and notificaciones else 0 %}

  <div id="notiModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">

    {# overlay #}
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeNotiModal()"></div>

    {# panel #}
    <div class="relative mx-auto mt-6 md:mt-10 w-[94vw] max-w-5xl">
      <div class="noti-modal-panel rounded-3xl overflow-hidden border border-white/10 shadow-[0_30px_90px_rgba(0,0,0,.65)] bg-gradient-to-b from-white/[0.06] to-white/[0.03]">

        {# header #}
        <div class="px-5 md:px-7 py-5 border-b border-white/10 flex items-start justify-between gap-4">
          <div class="flex items-start gap-3">
            <div class="w-11 h-11 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center">
              <span class="material-symbols-outlined text-white/80">notifications_active</span>
            </div>

            <div>
              <h4 class="text-white font-extrabold text-lg md:text-xl leading-tight">
                Notificaciones
              </h4>
              <p class="text-xs md:text-sm text-white/50 mt-1">
                Toca una fila para <span class="text-white/80 font-semibold">marcar como le√≠do</span> y ocultar el aviso.
              </p>

              {% if noti_count > 0 %}
                <div class="mt-3 inline-flex items-center gap-2 text-[11px] font-bold px-3 py-1 rounded-full
                            bg-red-500/10 text-red-200 border border-red-500/20">
                  <span class="w-1.5 h-1.5 rounded-full bg-red-300"></span>
                  {{ noti_count }} aviso(s) sin leer
                </div>
              {% endif %}
            </div>
          </div>

          <button
            type="button"
            class="p-2 rounded-xl hover:bg-white/5 text-white/60 hover:text-white transition"
            onclick="closeNotiModal()"
            aria-label="Cerrar"
            title="Cerrar"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        {# body #}
       <div class="noti-body px-4 md:px-7 py-4">
          {% if notificaciones and notificaciones|length > 0 %}

            <div class="rounded-2xl border border-white/10 overflow-hidden bg-black/20">
              <div class="noti-scroll">

                <table class="w-full text-left">
                  <thead class="sticky top-0 z-10 bg-surface-dark/90 backdrop-blur-md border-b border-white/10">
                    <tr>
                      <th class="px-5 py-3 text-[11px] font-extrabold uppercase tracking-widest text-white/70">Cliente</th>
                      <th class="px-5 py-3 text-[11px] font-extrabold uppercase tracking-widest text-white/70">C√©dula</th>
                      <th class="px-5 py-3 text-[11px] font-extrabold uppercase tracking-widest text-white/70 hidden md:table-cell">Tel√©fono</th>
                      <th class="px-5 py-3 text-[11px] font-extrabold uppercase tracking-widest text-white/70 hidden lg:table-cell">Email</th>
                      <th class="px-5 py-3 text-[11px] font-extrabold uppercase tracking-widest text-white/70 text-right">Estado</th>
                    </tr>
                  </thead>

                  <tbody class="divide-y divide-white/10" id="notiBody">
                    {% for n in notificaciones %}
                      {% set tipo = n.tipo or 'renovacion' %}
                      {% set p = n.payload or {} %}

                      <tr
                        class="group cursor-pointer transition-colors hover:bg-white/[0.04]"
                        {# ‚úÖ usar _id del documento (n.noti_id no existe) #}
                        data-noti-id="{{ n._id|string }}"
                        data-noti-tipo="{{ tipo }}"
                        title="Clic para marcar como le√≠do"
                      >
                        <td class="px-5 py-4">
                          <div class="flex items-start gap-3">
                            <div class="mt-0.5 w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center">
                              {% if tipo == 'cumpleanos' %}
                                <span class="material-symbols-outlined text-white/70" style="font-size:18px;">cake</span>
                              {% else %}
                                <span class="material-symbols-outlined text-white/70" style="font-size:18px;">person</span>
                              {% endif %}
                            </div>

                            <div class="min-w-0">
                              <div class="text-white font-bold truncate">
                                {{ p.nombre or '-' }}
                              </div>
                              <div class="text-[11px] text-white/45 mt-0.5">
                                {% if tipo == 'cumpleanos' %}
                                  Cumplea√±os de hoy üéâ (clic para marcar le√≠do)
                                {% else %}
                                  Renovaci√≥n pendiente (clic para marcar le√≠do)
                                {% endif %}
                                <span class="inline-block ml-1 text-white/35 group-hover:text-white/60 transition">‚Üí</span>
                              </div>
                            </div>
                          </div>
                        </td>

                        <td class="px-5 py-4 text-sm text-white/70 font-medium">
                          {{ p.identificacion or '-' }}
                        </td>

                        <td class="px-5 py-4 text-sm text-white/55 hidden md:table-cell">
                          {{ p.telefono or '-' }}
                        </td>

                        <td class="px-5 py-4 text-sm text-white/55 hidden lg:table-cell">
                          {{ p.email or '-' }}
                        </td>

                        <td class="px-5 py-4 text-right">
                          {% if tipo == 'cumpleanos' %}
                            <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1
                                        rounded-full border border-green-500/25 bg-green-500/10 text-green-200">
                              <span class="w-1.5 h-1.5 rounded-full bg-green-300"></span>
                              Cumple hoy
                            </span>
                          {% else %}
                            {% set dr = p.dias_restantes %}
                            {% set no_renovo = p.no_renovo %}

                            {% if no_renovo %}
                              <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1
                                          rounded-full border border-red-500/25 bg-red-500/10 text-red-200">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-300"></span>
                                No renov√≥ ({{ (dr * -1) }} d√≠a(s))
                              </span>
                            {% else %}
                              {% if dr == 0 %}
                                <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1
                                            rounded-full border border-red-500/25 bg-red-500/10 text-red-200">
                                  <span class="w-1.5 h-1.5 rounded-full bg-red-300"></span>
                                  Vence hoy
                                </span>
                              {% elif dr in [1,2] %}
                                <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1
                                            rounded-full border border-yellow-500/25 bg-yellow-500/10 text-yellow-200">
                                  <span class="w-1.5 h-1.5 rounded-full bg-yellow-300"></span>
                                  Vence en {{ dr }} d√≠a(s)
                                </span>
                              {% else %}
                                <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1
                                            rounded-full border border-white/10 bg-white/5 text-white/70">
                                  <span class="w-1.5 h-1.5 rounded-full bg-white/40"></span>
                                  {{ dr }} d√≠a(s)
                                </span>
                              {% endif %}
                            {% endif %}

                            {% if p.fecha_hasta %}
                              <div class="text-[11px] text-white/40 mt-2">
                                Hasta: <span class="text-white/60 font-semibold">{{ p.fecha_hasta }}</span>
                              </div>
                            {% endif %}
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>

                </table>
              </div>
            </div>

          {% else %}
            <div class="rounded-2xl border border-white/10 bg-black/20 p-10 text-center">
              <div class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 mx-auto flex items-center justify-center">
                <span class="material-symbols-outlined text-white/45" style="font-size:28px;">done_all</span>
              </div>
              <div class="mt-4 text-white font-extrabold text-lg">Todo al d√≠a</div>
              <div class="mt-1 text-sm text-white/50">
                No hay notificaciones pendientes en este momento.
              </div>
            </div>
          {% endif %}
        </div>

        {# footer #}
        <div class="px-5 md:px-7 py-4 border-t border-white/10 flex items-center justify-between gap-3">
          <div class="text-xs text-white/40">
            Se ocultan autom√°ticamente cuando los marcas como le√≠dos.
          </div>

          <button
            type="button"
            class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-sm font-bold text-white transition"
            onclick="closeNotiModal()"
          >
            Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
  function openNotiModal() {
    const m = document.getElementById("notiModal");
    if (!m) return;
    m.classList.remove("hidden");
    m.setAttribute("aria-hidden","false");
     document.body.style.overflow = "hidden";
  }

  function closeNotiModal() {
    const m = document.getElementById("notiModal");
    if (!m) return;
    m.classList.add("hidden");
    m.setAttribute("aria-hidden","true");
     document.body.style.overflow = "";
  }

  (function () {
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeNotiModal();
    });
  })();

  function updateNotiBadge(delta){
    const badge = document.getElementById("notiBadge");
    if (!badge) return;

    const n = parseInt(badge.textContent || "0", 10) || 0;
    const next = Math.max(0, n + delta);
    badge.textContent = String(next);

    if (next === 0) badge.remove();
  }

  function renderEmptyNotis(){
    const body = document.getElementById("notiBody");
    if (!body) return;

    body.innerHTML = `
      <tr>
        <td class="px-6 py-10 text-center text-secondary" colspan="5">
          No hay notificaciones pendientes en este momento.
        </td>
      </tr>
    `;
  }

  async function markNotiVisto(tipo, notiId, tr){
    const resp = await fetch(`/admin/notificaciones/${encodeURIComponent(tipo)}/${encodeURIComponent(notiId)}/visto`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: "{}"
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || !data.ok) {
      alert((data && data.error) ? data.error : "No se pudo marcar como le√≠do");
      return;
    }

    tr.remove();
    updateNotiBadge(-1);

    const body = document.getElementById("notiBody");
    if (body && body.querySelectorAll("tr[data-noti-id]").length === 0){
      renderEmptyNotis();
    }
  }

  document.addEventListener("click", (e) => {
    const tr = e.target.closest("tr[data-noti-id]");
    if (!tr) return;

    const notiId = tr.getAttribute("data-noti-id");
    const tipo = tr.getAttribute("data-noti-tipo") || "renovacion";
    if (!notiId) return;

    if (!confirm("¬øMarcar esta notificaci√≥n como le√≠da?")) return;
    markNotiVisto(tipo, notiId, tr);
  });
</script>
{% endblock %}
