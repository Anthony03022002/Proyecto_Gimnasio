{% extends "base_admin.html" %}
{% block title %}Alumno{% endblock %}

{% block header %}
  <header class="h-20 bg-surface-dark/50 backdrop-blur-md px-5 md:px-8 flex items-center justify-between sticky top-0 z-10 border-b border-white/5">
    <!-- IZQUIERDA -->
    <div class="flex items-center gap-3 min-w-0">
      <button
        type="button"
        class="md:hidden p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
        onclick="openDrawer()"
        aria-label="Abrir menú"
      >
        <span class="material-symbols-outlined">menu</span>
      </button>

      <h2 class="text-xl md:text-2xl font-bold text-white truncate">
        Entrenador
      </h2>
    </div>

    <!-- DERECHA (acciones) -->
    <div class="flex items-center gap-3">
      {# aquí van botones / avatar / salir, etc #}
    </div>
  </header>
{% endblock %}


{% block content %}

<style>
  :root{
    /* Base dark minimal */
    --bg: #0f1115;
    --surface: #151821;
    --surface-2: rgba(255,255,255,.03);
    --border: rgba(255,255,255,.08);
    --border-2: rgba(255,255,255,.06);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.55);

    /* Accent sutil (puedes mantener dorado pero sin exagerar) */
    --accent: #D4AF37;
    --accent-soft: rgba(212,175,55,.12);
    --danger: #fb7185;
    --danger-soft: rgba(251,113,133,.12);

    --r-xl: 18px;
    --r-lg: 14px;
    --r-md: 12px;
  }

  /* ===== Page wrapper ===== */
  .elite-wrap{
    background:
      radial-gradient(1100px 520px at 15% -20%, rgba(212,175,55,.10), transparent 60%),
      radial-gradient(900px 520px at 110% 0%, rgba(255,255,255,.06), transparent 55%),
      var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    padding: 16px;
  }

  @media (min-width: 768px){
    .elite-wrap{ padding: 18px; }
  }

  /* ===== Card base (reemplaza glass pesado) ===== */
  .glass-panel{
    background: rgba(255,255,255,.03);
    reveal: none;
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    overflow: hidden;
    box-shadow: 0 16px 50px rgba(0,0,0,.35);
    backdrop-filter: blur(10px);
  }

  /* encabezados de secciones: sin Cinzel, más limpio */
  .glass-panel .p-3.p-md-4.border-bottom h5{
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
    letter-spacing: .02em !important;
    text-transform: none !important;
    font-weight: 800 !important;
    font-size: 1rem !important;
    color: var(--text);
    margin: 0;
  }

  /* badges: pill minimal */
  .elite-wrap .badge{
    font-size: 11px;
    font-weight: 800;
    border-radius: 999px !important;
    letter-spacing: .06em;
    text-transform: uppercase;
    padding: 6px 10px;
  }

  /* ===== Text colors ===== */
  .elite-wrap, .elite-wrap *{ color: var(--text); }
  .elite-wrap .text-muted{ color: var(--muted) !important; }

  /* ===== Forms ===== */
  .elite-wrap .form-label{
    font-size: 11px;
    font-weight: 800;
    letter-spacing: .06em;
    text-transform: uppercase;
    color: rgba(255,255,255,.55);
    margin-bottom: 6px;
  }

  .elite-wrap .form-control,
  .elite-wrap .form-select{
    background: rgba(255,255,255,.05) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    color: var(--text) !important;
    border-radius: var(--r-md) !important;
    padding: 10px 12px !important;
    transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
  }

  .elite-wrap .form-control::placeholder{ color: rgba(255,255,255,.35); }

  .elite-wrap .form-control:focus,
  .elite-wrap .form-select:focus{
    outline: none !important;
    border-color: rgba(212,175,55,.38) !important;
    box-shadow: 0 0 0 3px rgba(212,175,55,.14) !important;
    background: rgba(255,255,255,.06) !important;
  }

  /* Fix options en select */
  .elite-wrap .form-select option{
    background: #fff !important;
    color: #111827 !important;
  }

  /* ===== Buttons ===== */
  .metallic-border-btn{
    border: 1px solid rgba(255,255,255,.12) !important;
    background: rgba(255,255,255,.04) !important;
    border-radius: 12px !important;
    transition: transform .12s ease, background-color .12s ease, border-color .12s ease;
  }
  .metallic-border-btn:hover{
    background: rgba(255,255,255,.07) !important;
    border-color: rgba(255,255,255,.20) !important;
    transform: translateY(-1px);
  }
  .metallic-border-btn:focus{
    box-shadow: 0 0 0 3px rgba(255,255,255,.10) !important;
  }

  .copper-gold-btn{
    background: linear-gradient(135deg, rgba(212,175,55,.9) 0%, rgba(212,175,55,.65) 100%) !important;
    color: #101114 !important;
    border-radius: 14px !important;
    font-weight: 900;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  }
  .copper-gold-btn:hover{
    transform: translateY(-1px);
    filter: brightness(1.02);
    box-shadow: 0 16px 40px rgba(212,175,55,.20);
  }

  /* ===== Alerts (más clean) ===== */
  .elite-alert{
    background: var(--accent-soft);
    border: 1px solid rgba(212,175,55,.22);
    border-radius: var(--r-lg);
    padding: 14px;
  }
  .elite-alert-secondary{
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--r-lg);
    padding: 14px;
  }

  .elite-wrap hr{
    border-color: rgba(255,255,255,.08) !important;
    opacity: 1;
  }

  /* ===== Thumbs (imágenes plan) ===== */
  .thumb-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 12px;
  }
  @media (min-width: 576px){ .thumb-grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
  @media (min-width: 992px){ .thumb-grid{ grid-template-columns: repeat(4,minmax(0,1fr)); } }

  .thumb-item{
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--r-lg);
    padding: 10px;
  }
  .thumb-item img{
    width: 100%;
    height: 110px;
    border-radius: 12px;
    object-fit: cover;
    display:block;
  }

  /* ===== KPI cards ===== */
  .gold-gradient-text{
    /* se mantiene, pero más sutil */
    background: linear-gradient(to right, rgba(212,175,55,1), rgba(255,255,255,.88));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* ===== Progreso grid ===== */
  .prog-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 12px;
  }
  @media (min-width: 576px){ .prog-grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
  @media (min-width: 992px){ .prog-grid{ grid-template-columns: repeat(6,minmax(0,1fr)); } }

  .prog-card{
    aspect-ratio: 3 / 4;
    border-radius: var(--r-lg);
    overflow: hidden;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    position: relative;
  }

  .prog-card img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: saturate(.85) contrast(1.05);
    transition: transform .35s ease, filter .35s ease;
  }
  .prog-card:hover img{
    transform: scale(1.04);
    filter: saturate(1) contrast(1.08);
  }

  .prog-overlay{
    position:absolute; inset:0;
    display:flex; flex-direction:column; justify-content:flex-end;
    padding: 12px;
    background: linear-gradient(to top, rgba(0,0,0,.72), rgba(0,0,0,0));
    opacity: 0;
    transition: opacity .18s ease;
  }
  .prog-card:hover .prog-overlay{ opacity: 1; }

  header h2{
    letter-spacing: .01em;
  }
</style>

<div class="elite-wrap">


  <div class="row g-3">

    {# =========================
       PLANIFICACIÓN (IZQ)
       ========================= #}
    <div class="col-12 col-xl-6">
      <section class="glass-panel overflow-hidden">

        <div class="p-3 p-md-4 border-bottom" style="border-color: rgba(255,255,255,.06)!important;">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0" style="font-family:'Cinzel',serif;letter-spacing:.18em;text-transform:uppercase;font-size:1rem;">
              Planificación del alumno
            </h5>
            <span class="badge" style="background: rgba(212,175,55,.10); color: var(--primary-gold); border:1px solid rgba(212,175,55,.20); border-radius:999px;">
              PDF / Imágenes
            </span>
          </div>
        </div>

        <div class="p-3 p-md-4">

          {% if plan %}

            {# PDF actual #}
            {% if plan.filename or plan.rel_path %}
              <div class="elite-alert mb-3 d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                  <div class="rounded-3 d-flex align-items-center justify-content-center"
                       style="width:46px;height:46px;background: rgba(212,175,55,.10); border:1px solid rgba(212,175,55,.18);">
                    <span class="material-symbols-outlined" style="color: var(--primary-gold); font-size:28px;">description</span>
                  </div>
                  <div>
                    <div class="fw-bold">Planificación (PDF) actual</div>
                    <div class="text-muted small" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
                      {{ plan.filename }}
                      {% if plan.bytes %} • {{ (plan.bytes / 1024 / 1024) | round(2) }} MB{% endif %}
                    </div>
                  </div>
                </div>

                {% if plan._id %}
                  <div class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-sm metallic-border-btn"
                       href="{{ url_for('web.descargar_planificacion', plan_id=plan._id) }}"
                       style="color: var(--primary-gold);">
                      <span class="material-symbols-outlined" style="font-size:18px;vertical-align:-4px;">download</span>
                      <span style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;font-weight:800;">Descargar</span>
                    </a>

                    <form method="post"
                          action="{{ url_for('web.eliminar_plan_pdf', plan_id=plan._id) }}"
                          onsubmit="return confirm('¿Eliminar el PDF actual?');">
                      <button class="btn btn-sm metallic-border-btn"
                              type="submit"
                              style="color:#fb7185;border-color: rgba(251,113,133,.35) !important;">
                        <span class="material-symbols-outlined" style="font-size:18px;vertical-align:-4px;">delete</span>
                        <span style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;font-weight:800;">Eliminar</span>
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="elite-alert-secondary mb-3">
                No hay PDF guardado para este alumno.
              </div>
            {% endif %}

            {# Imágenes actuales del plan #}
            {% if plan.images and plan.images|length > 0 %}
              <hr class="my-4" />
              <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div class="fw-bold">Imágenes actuales</div>

                <form method="post"
                      action="{{ url_for('web.eliminar_plan_imagenes', plan_id=plan._id) }}"
                      onsubmit="return confirm('¿Eliminar TODAS las imágenes?');">
                  <button class="btn btn-sm metallic-border-btn"
                          type="submit"
                          style="color:#fb7185;border-color: rgba(251,113,133,.35) !important;">
                    <span class="material-symbols-outlined" style="font-size:18px;vertical-align:-4px;">delete</span>
                    <span style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;font-weight:800;">Eliminar todas</span>
                  </button>
                </form>
              </div>

              <div class="thumb-grid">
                {% for img in plan.images %}
                  <div class="thumb-item">
                    <a href="{{ url_for('web.ver_plan_imagen', plan_id=plan._id, idx=loop.index0) }}"
                       target="_blank"
                       title="{{ img.filename }}">
                      <img
                        src="{{ url_for('web.ver_plan_imagen', plan_id=plan._id, idx=loop.index0) }}"
                        alt="{{ img.filename }}"
                        loading="lazy">
                    </a>

                    <form method="post"
                          class="mt-2 thumb-actions"
                          action="{{ url_for('web.eliminar_plan_imagen', plan_id=plan._id, idx=loop.index0) }}"
                          onsubmit="return confirm('¿Eliminar esta imagen?');">
                      <button class="btn btn-sm metallic-border-btn"
                              type="submit"
                              style="color:#fb7185;border-color: rgba(251,113,133,.35) !important;">
                        <i class="bi bi-trash"></i>
                        <span style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;font-weight:800;">Eliminar</span>
                      </button>
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <hr class="my-4" />

          {% else %}
            <div class="elite-alert-secondary mb-3">
              Aún no has subido una planificación para este alumno.
            </div>
            <hr class="my-4" />
          {% endif %}

          {# SUBIR PLANIFICACIÓN (mantengo ids y form action igual) #}
          <div class="mb-3" style="font-size:10px;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.45);font-weight:800;">
            Subir / Reemplazar planificación
          </div>

          <form method="post"
                action="{{ url_for('web.subir_planificacion', cliente_id=cliente_id) }}"
                enctype="multipart/form-data"
                id="formPlan">

            <div class="mb-3">
              <label class="form-label">Subir/Reemplazar PDF (opcional)</label>
              <input type="file" name="pdf" accept="application/pdf" class="form-control gold-input-focus" id="inpPdf">
            </div>

            <div class="mb-3">
              <label class="form-label">Subir imágenes (opcional)</label>
              <input type="file" name="imagenes" accept="image/*" multiple class="form-control gold-input-focus" id="inpImgs">
              <div class="text-muted small mt-2">
                Puedes subir un PDF y/o varias imágenes. Abajo verás lo que vas a enviar.
              </div>
            </div>

            {# Preview (mantengo ids) #}
            <div class="mt-3">
              <div class="fw-bold mb-2">Archivos por subir</div>

              <div id="previewEmpty" class="text-muted small">
                No has seleccionado archivos aún.
              </div>

              <div id="previewPdfWrap" class="d-none mb-2">
                <div class="text-muted small mb-1">PDF</div>
                <ul class="list-group" id="previewPdfList"></ul>
              </div>

              <div id="previewImgsWrap" class="d-none">
                <div class="text-muted small mb-1">Imágenes</div>
                <div class="d-flex flex-wrap gap-2" id="previewImgsGrid"></div>
              </div>
            </div>

            <button class="btn copper-gold-btn w-100 mt-3 py-3"
                    type="submit">
              <span class="material-symbols-outlined" style="font-size:18px;vertical-align:-4px;">save</span>
              <span style="font-size:10px;letter-spacing:.22em;text-transform:uppercase;font-weight:900;">
                Guardar planificación
              </span>
            </button>

          </form>

        </div>
      </section>
    </div>

    {# =========================
       KPI (DER)
       ========================= #}
    <div class="col-12 col-xl-6">
      <section class="glass-panel overflow-hidden">

        <div class="p-3 p-md-4 border-bottom" style="border-color: rgba(255,255,255,.06)!important;">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0" style="font-family:'Cinzel',serif;letter-spacing:.18em;text-transform:uppercase;font-size:1rem;">
              Historial corporal <span style="color: var(--primary-gold); font-style: italic; font-family: Inter, sans-serif;">(KPI)</span>
            </h5>
            <span class="badge" style="background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); border-radius:999px; color: rgba(255,255,255,.60);">
              Mediciones
            </span>
          </div>
        </div>

        <div class="p-3 p-md-4">

          {# FORM KPI (Jinja igual, solo estilos) #}
          <form class="row g-2"
                method="post"
                action="{{ url_for('web.entrenador_medidas_crear', cliente_id=cliente_id) }}">

            <div class="col-12 col-md-3">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-control gold-input-focus" name="fecha">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Peso (kg)</label>
              <input type="number" step="0.1" class="form-control gold-input-focus" name="peso_kg" required>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">% Grasa</label>
              <input type="number" step="0.1" class="form-control gold-input-focus" name="grasa_pct" required>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">% Músculo</label>
              <input type="number" step="0.1" min="1" max="80" class="form-control gold-input-focus" name="musculo_pct" required>
            </div>

            <div class="col-12 d-grid mt-2">
              <button class="btn"
                      type="submit"
                      style="background: rgba(212,175,55,.20); border:1px solid rgba(212,175,55,.40); color: var(--primary-gold); border-radius: 12px;">
                <span class="material-symbols-outlined" style="font-size:18px;vertical-align:-4px;">add_circle</span>
                <span style="font-size:10px;letter-spacing:.22em;text-transform:uppercase;font-weight:900;">
                  Guardar medición
                </span>
              </button>
            </div>
          </form>

          {% if kpi_latest %}
            {% set peso_now  = (kpi_latest.peso_kg if kpi_latest and kpi_latest.peso_kg is not none else 0) %}
            {% set grasa_now = (kpi_latest.grasa_pct if kpi_latest and kpi_latest.grasa_pct is not none else 0) %}
            {% set musc_now  = (kpi_latest.musculo_pct if kpi_latest and kpi_latest.musculo_pct is not none else 0) %}

            {% set peso_prev  = (kpi_prev.peso_kg if kpi_prev and kpi_prev.peso_kg is not none else none) %}
            {% set grasa_prev = (kpi_prev.grasa_pct if kpi_prev and kpi_prev.grasa_pct is not none else none) %}
            {% set musc_prev  = (kpi_prev.musculo_pct if kpi_prev and kpi_prev.musculo_pct is not none else none) %}

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-4">
                <div class="p-3 text-center rounded-4"
                     style="background: rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06); position:relative; overflow:hidden;">
                  <div class="text-muted" style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;">Peso</div>
                  <div class="d-flex justify-content-center align-items-baseline gap-1 mt-2">
                    <div class="gold-gradient-text" style="font-family:'Cinzel',serif;font-weight:800;font-size:2.2rem;line-height:1;">
                      {{ "%.1f"|format(peso_now|float) }}
                    </div>
                    <div class="text-muted small">kg</div>
                  </div>
                  {% if peso_prev is not none %}
                    <div class="text-muted small mt-1">
                      Δ {{ "%.1f"|format((peso_now|float - peso_prev|float)) }} kg
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-12 col-md-4">
                <div class="p-3 text-center rounded-4"
                     style="background: rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06);">
                  <div class="text-muted" style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;">% Grasa</div>
                  <div class="d-flex justify-content-center align-items-baseline gap-1 mt-2">
                    <div class="gold-gradient-text" style="font-family:'Cinzel',serif;font-weight:800;font-size:2.2rem;line-height:1;">
                      {{ "%.1f"|format(grasa_now|float) }}
                    </div>
                    <div class="text-muted small">%</div>
                  </div>
                  {% if grasa_prev is not none %}
                    <div class="text-muted small mt-1">
                      Δ {{ "%.1f"|format((grasa_now|float - grasa_prev|float)) }}%
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-12 col-md-4">
                <div class="p-3 text-center rounded-4"
                     style="background: rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06);">
                  <div class="text-muted" style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;">% Músculo</div>
                  <div class="d-flex justify-content-center align-items-baseline gap-1 mt-2">
                    <div class="gold-gradient-text" style="font-family:'Cinzel',serif;font-weight:800;font-size:2.2rem;line-height:1;">
                      {{ "%.1f"|format(musc_now|float) }}
                    </div>
                    <div class="text-muted small">%</div>
                  </div>
                  {% if musc_prev is not none %}
                    <div class="text-muted small mt-1">
                      Δ {{ "%.1f"|format((musc_now|float - musc_prev|float)) }}%
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="mt-3 p-3 rounded-4"
                 style="background: rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06);">
              <canvas id="chartMedidas" height="120"></canvas>
            </div>

            <script id="chartMedidasPayload" type="application/json">
              {{ chart_json|default('{"labels":[],"peso":[],"grasa":[],"musculo":[]}')|safe }}
            </script>

          {% else %}
            <div class="elite-alert-secondary mt-3">
              Aún no hay mediciones registradas.
            </div>
          {% endif %}

        </div>
      </section>
    </div>

  </div>

  {# =========================
     FOTOS PROGRESO (ABAJO)
     ========================= #}
  <section class="glass-panel overflow-hidden mt-3">
    <div class="p-3 p-md-4 border-bottom d-flex justify-content-between align-items-center flex-wrap gap-2"
         style="border-color: rgba(255,255,255,.06)!important;">
      <h5 class="mb-0" style="font-family:'Cinzel',serif;letter-spacing:.18em;text-transform:uppercase;font-size:1rem;">
        Fotos de progreso del alumno
      </h5>
      <div class="text-muted small">
        {% if fotos_progreso %}{{ fotos_progreso|length }} foto(s){% endif %}
      </div>
    </div>

    <div class="p-3 p-md-4">
      {% if fotos_progreso and fotos_progreso|length > 0 %}
        <div class="prog-grid">
          {% for img in fotos_progreso %}
            <div class="prog-card">
              <a href="{{ url_for('web.entrenador_progreso_ver_foto', cliente_id=cliente_id, foto_id=img._id) }}"
                 target="_blank">
                <img
                  src="{{ url_for('web.entrenador_progreso_ver_foto', cliente_id=cliente_id, foto_id=img._id) }}"
                  alt="foto progreso"
                  loading="lazy">
              </a>

              <div class="prog-overlay">
                <div class="text-muted" style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;">
                  {% if img.creado %}{{ img.creado.strftime('%d/%m/%Y') }}{% endif %}
                </div>
                <div style="color: var(--primary-gold); font-weight:800;">
                  {{ img.filename or 'foto' }}
                </div>

                <div class="mt-2 d-grid gap-2">
                  <a class="btn btn-sm metallic-border-btn"
                     href="{{ url_for('web.entrenador_progreso_descargar_foto', cliente_id=cliente_id, foto_id=img._id) }}"
                     style="color: var(--primary-gold);">
                    <i class="bi bi-download"></i>
                    <span style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;font-weight:800;">
                      Descargar
                    </span>
                  </a>

                  <form method="post"
                        action="{{ url_for('web.entrenador_progreso_eliminar_foto', cliente_id=cliente_id, foto_id=img._id) }}"
                        onsubmit="return confirm('¿Eliminar esta foto?');">
                    <button type="submit"
                            class="btn btn-sm metallic-border-btn w-100"
                            style="color:#fb7185;border-color: rgba(251,113,133,.35) !important;">
                      <i class="bi bi-trash"></i>
                      <span style="font-size:10px;letter-spacing:.2em;text-transform:uppercase;font-weight:800;">
                        Eliminar
                      </span>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="elite-alert-secondary">
          Este alumno aún no ha subido fotos de progreso.
        </div>
      {% endif %}
    </div>
  </section>

</div>

{# =========================
   JS (igual que el tuyo, SOLO lo dejo intacto)
   ========================= #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const inpPdf = document.getElementById("inpPdf");
    const inpImgs = document.getElementById("inpImgs");

    const previewEmpty = document.getElementById("previewEmpty");
    const previewPdfWrap = document.getElementById("previewPdfWrap");
    const previewPdfList = document.getElementById("previewPdfList");

    const previewImgsWrap = document.getElementById("previewImgsWrap");
    const previewImgsGrid = document.getElementById("previewImgsGrid");

    if (!inpPdf || !inpImgs) return;

    let pdfFile = null;
    let imgFiles = [];

    function humanSize(bytes) {
      if (!bytes && bytes !== 0) return "";
      const mb = bytes / 1024 / 1024;
      if (mb >= 1) return `${mb.toFixed(2)} MB`;
      const kb = bytes / 1024;
      return `${kb.toFixed(0)} KB`;
    }

    function syncInputs() {
      const dtPdf = new DataTransfer();
      if (pdfFile) dtPdf.items.add(pdfFile);
      inpPdf.files = dtPdf.files;

      const dtImgs = new DataTransfer();
      imgFiles.forEach((f) => dtImgs.items.add(f));
      inpImgs.files = dtImgs.files;
    }

    function render() {
      const hasPdf = !!pdfFile;
      const hasImgs = imgFiles.length > 0;

      previewEmpty.classList.toggle("d-none", hasPdf || hasImgs);

      previewPdfWrap.classList.toggle("d-none", !hasPdf);
      previewPdfList.innerHTML = "";
      if (hasPdf) {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.style.background = "rgba(255,255,255,.03)";
        li.style.borderColor = "rgba(255,255,255,.10)";
        li.style.color = "rgba(255,255,255,.9)";
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${pdfFile.name}</div>
            <div class="small text-muted">${humanSize(pdfFile.size)}</div>
          </div>
          <button type="button" class="btn btn-sm metallic-border-btn" id="btnDelPdf" style="color:#fb7185;border-color: rgba(251,113,133,.35) !important;">
            <i class="bi bi-trash"></i>
          </button>
        `;
        previewPdfList.appendChild(li);

        li.querySelector("#btnDelPdf").addEventListener("click", () => {
          pdfFile = null;
          syncInputs();
          render();
        });
      }

      previewImgsWrap.classList.toggle("d-none", !hasImgs);
      previewImgsGrid.innerHTML = "";
      if (hasImgs) {
        imgFiles.forEach((f, idx) => {
          const card = document.createElement("div");
          card.className = "border rounded p-2";
          card.style.width = "140px";
          card.style.background = "rgba(255,255,255,.03)";
          card.style.borderColor = "rgba(255,255,255,.10)";

          const url = URL.createObjectURL(f);
          card.innerHTML = `
            <img src="${url}" alt="${f.name}"
                 style="width:100%;height:96px;object-fit:cover;border-radius:12px;">
            <div class="small mt-1 text-truncate" title="${f.name}" style="color:rgba(255,255,255,.9)">${f.name}</div>
            <div class="small text-muted">${humanSize(f.size)}</div>
            <button type="button" class="btn btn-sm metallic-border-btn w-100 mt-2" style="color:#fb7185;border-color: rgba(251,113,133,.35) !important;">
              <i class="bi bi-trash"></i> Quitar
            </button>
          `;

          card.querySelector("button").addEventListener("click", () => {
            imgFiles.splice(idx, 1);
            syncInputs();
            render();
          });

          previewImgsGrid.appendChild(card);
        });
      }
    }

    inpPdf.addEventListener("change", () => {
      pdfFile = inpPdf.files && inpPdf.files[0] ? inpPdf.files[0] : null;
      syncInputs();
      render();
    });

    inpImgs.addEventListener("change", () => {
      imgFiles = Array.from(inpImgs.files || []);
      syncInputs();
      render();
    });

    render();
  })();

  (function () {
    const canvas = document.getElementById("chartMedidas");
    if (!canvas) return;

    if (typeof Chart === "undefined") {
      console.error("Chart.js no cargó (Chart undefined).");
      return;
    }

    const payloadEl = document.getElementById("chartMedidasPayload");
    let payload = { labels: [], peso: [], grasa: [], musculo: [] };

    if (payloadEl && payloadEl.textContent) {
      try { payload = JSON.parse(payloadEl.textContent); }
      catch (e) { console.error("chart_json inválido:", e); }
    }

    new Chart(canvas, {
      type: "line",
      data: {
        labels: payload.labels || [],
        datasets: [
          { label: "Peso (kg)", data: payload.peso || [], tension: 0.3 },
          { label: "% Grasa", data: payload.grasa || [], tension: 0.3 },
          { label: "% Músculo", data: payload.musculo || [], tension: 0.3 },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: false } },
      },
    });
  })();
</script>

{% endblock %}
