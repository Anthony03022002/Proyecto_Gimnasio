{% extends "base.html" %} {% block title %}Alumno{% endblock %} {% block content
%}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">{{ (alumno.nombre ~ ' ' ~ alumno.apellido)|trim }}</h4>
    <div class="text-muted small">
      {{ alumno.email or '' }} {% if alumno.telefono %}· {{ alumno.telefono }}{%
      endif %}
    </div>
  </div>

  <a
    class="btn btn-sm btn-outline-secondary"
    href="{{ url_for('web.entrenador_mis_alumnos') }}"
  >
    ← Volver
  </a>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header">Planificación del alumno</div>

      <div class="card-body">
        {% if plan %} {# ✅ PDF actual SOLO si existe filename/rel_path #} {% if
        plan.filename or plan.rel_path %}
        <div class="alert alert-success">
          <div class="fw-semibold">Planificación (PDF) actual</div>
          <div class="small text-muted">
            {{ plan.filename }} {% if plan.bytes %}· {{ (plan.bytes / 1024 /
            1024) | round(2) }} MB{% endif %}
          </div>
        </div>

        {% if plan._id %}
        <div class="d-flex gap-2 flex-wrap">
          <a
            class="btn btn-outline-secondary btn-sm"
            href="{{ url_for('web.descargar_planificacion', plan_id=plan._id) }}"
          >
            Descargar PDF
          </a>

          <form
            method="post"
            action="{{ url_for('web.eliminar_plan_pdf', plan_id=plan._id) }}"
            onsubmit="return confirm('¿Eliminar el PDF actual?');"
          >
            <button class="btn btn-outline-danger btn-sm" type="submit">
              <i class="bi bi-trash"></i> Eliminar PDF
            </button>
          </form>
        </div>
        {% endif %} {% else %}
        <div class="alert alert-secondary">
          No hay PDF guardado para este alumno.
        </div>
        {% endif %} {% if plan.images and plan.images|length > 0 %}
        <hr />
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Imágenes actuales</div>

          <form
            method="post"
            action="{{ url_for('web.eliminar_plan_imagenes', plan_id=plan._id) }}"
            onsubmit="return confirm('¿Eliminar TODAS las imágenes?');"
          >
            <button class="btn btn-outline-danger btn-sm" type="submit">
              <i class="bi bi-trash"></i> Eliminar todas
            </button>
          </form>
        </div>

        <div class="d-flex flex-wrap gap-2">
          {% for img in plan.images %}
          <div class="border rounded p-1">
            <a
              href="{{ url_for('web.ver_plan_imagen', plan_id=plan._id, idx=loop.index0) }}"
              target="_blank"
              title="{{ img.filename }}"
            >
              <img
                src="{{ url_for('web.ver_plan_imagen', plan_id=plan._id, idx=loop.index0) }}"
                alt="{{ img.filename }}"
                style="
                  width: 90px;
                  height: 90px;
                  object-fit: cover;
                  border-radius: 6px;
                "
              />
            </a>

            <form
              method="post"
              class="mt-1"
              action="{{ url_for('web.eliminar_plan_imagen', plan_id=plan._id, idx=loop.index0) }}"
              onsubmit="return confirm('¿Eliminar esta imagen?');"
            >
              <button class="btn btn-outline-danger btn-sm w-100" type="submit">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <hr />
        {% else %}
        <div class="alert alert-secondary">
          Aún no has subido una planificación para este alumno.
        </div>
        <hr />
        {% endif %} {# ============================ ✅ KPI + HISTORIAL MEDIDAS
        ============================ #}

        <h6 class="text-muted mb-2">Historial corporal (KPI)</h6>

        <form
          class="row g-2"
          method="post"
          action="{{ url_for('web.entrenador_medidas_crear', cliente_id=cliente_id) }}"
        >
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Fecha</label>
            <input type="date" class="form-control" name="fecha" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Peso (kg)</label>
            <input
              type="number"
              step="0.1"
              class="form-control"
              name="peso_kg"
              required
            />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label mb-1">% Grasa</label>
            <input
              type="number"
              step="0.1"
              class="form-control"
              name="grasa_pct"
              required
            />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label mb-1">% Músculo</label>
            <input
              type="number"
              step="0.1"
              min="1"
              max="80"
              class="form-control"
              name="musculo_pct"
              required
            />
          </div>

          <div class="col-12 d-grid mt-1">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-plus-circle"></i> Guardar medición
            </button>
          </div>
        </form>

        {% if kpi_latest %} {# ✅ valores seguros (evita None/string) #} {% set
        peso_now = (kpi_latest.peso_kg if kpi_latest and kpi_latest.peso_kg is
        not none else 0) %} {% set grasa_now = (kpi_latest.grasa_pct if
        kpi_latest and kpi_latest.grasa_pct is not none else 0) %} {% set
        musc_now = (kpi_latest.musculo_pct if kpi_latest and
        kpi_latest.musculo_pct is not none else 0) %} {% set peso_prev =
        (kpi_prev.peso_kg if kpi_prev and kpi_prev.peso_kg is not none else
        none) %} {% set grasa_prev = (kpi_prev.grasa_pct if kpi_prev and
        kpi_prev.grasa_pct is not none else none) %} {% set musc_prev =
        (kpi_prev.musculo_pct if kpi_prev and kpi_prev.musculo_pct is not none
        else none) %}

        <div class="row g-2 mt-3">
          <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-3">
                <div class="text-muted small">Peso</div>
                <div class="fs-4 fw-semibold">
                  {{ "%.1f"|format(peso_now|float) }} kg
                </div>
                {% if peso_prev is not none %}
                <div class="small text-muted">
                  Δ {{ "%.1f"|format((peso_now|float - peso_prev|float)) }} kg
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-3">
                <div class="text-muted small">% Grasa</div>
                <div class="fs-4 fw-semibold">
                  {{ "%.1f"|format(grasa_now|float) }}%
                </div>
                {% if grasa_prev is not none %}
                <div class="small text-muted">
                  Δ {{ "%.1f"|format((grasa_now|float - grasa_prev|float)) }}%
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-3">
                <div class="text-muted small">% Músculo</div>
                <div class="fs-4 fw-semibold">
                  {{ "%.1f"|format(musc_now|float) }}%
                </div>
                {% if musc_prev is not none %}
                <div class="small text-muted">
                  Δ {{ "%.1f"|format((musc_now|float - musc_prev|float)) }}%
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <canvas id="chartMedidas" height="120"></canvas>
        </div>

        {# ✅ payload seguro siempre (no deja "const payload = ;") #}
        <script id="chartMedidasPayload" type="application/json">
          {{ chart_json|default('{"labels":[],"peso":[],"grasa":[],"musculo":[]}')|safe }}
        </script>

        {% else %}
        <div class="text-muted small mt-3">
          Aún no hay mediciones registradas.
        </div>
        {% endif %}

        <hr />

        <hr class="my-3" />

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Fotos de progreso del alumno</div>
          <div class="text-muted small">
            {% if fotos_progreso %}{{ fotos_progreso|length }} foto(s){% endif
            %}
          </div>
        </div>

        {% if fotos_progreso and fotos_progreso|length > 0 %}
        <div class="d-flex flex-wrap gap-2">
          {% for img in fotos_progreso %}
          <div class="border rounded p-2" style="width: 140px">
            <a
              class="d-block mb-2"
              href="{{ url_for('web.entrenador_progreso_ver_foto', cliente_id=cliente_id, foto_id=img._id) }}"
              target="_blank"
            >
              <img
                src="{{ url_for('web.entrenador_progreso_ver_foto', cliente_id=cliente_id, foto_id=img._id) }}"
                alt="foto progreso"
                style="
                  width: 100%;
                  height: 90px;
                  object-fit: cover;
                  border-radius: 6px;
                "
                loading="lazy"
              />
            </a>

            <div
              class="small text-muted text-truncate"
              title="{{ img.filename or '' }}"
            >
              {{ img.filename or 'foto' }}
            </div>

            <div class="small text-muted mb-2">
              {% if img.creado %}{{ img.creado.strftime('%d/%m/%Y') }}{% endif
              %}
            </div>

            <a
              class="btn btn-sm btn-outline-secondary w-100 mb-1"
              href="{{ url_for('web.entrenador_progreso_descargar_foto', cliente_id=cliente_id, foto_id=img._id) }}"
            >
              <i class="bi bi-download"></i> Descargar
            </a>

            <form
              method="post"
              action="{{ url_for('web.entrenador_progreso_eliminar_foto', cliente_id=cliente_id, foto_id=img._id) }}"
              onsubmit="return confirm('¿Eliminar esta foto?');"
            >
              <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-muted small">
          Este alumno aún no ha subido fotos de progreso.
        </div>
        {% endif %} {# ============================ ✅ SUBIR PLANIFICACIÓN
        (PDF/IMGS) + PREVIEW ============================ #}
        <form
          method="post"
          action="{{ url_for('web.subir_planificacion', cliente_id=cliente_id) }}"
          enctype="multipart/form-data"
          id="formPlan"
        >
          <label class="form-label">Subir/Reemplazar PDF (opcional)</label>
          <input
            type="file"
            name="pdf"
            accept="application/pdf"
            class="form-control"
            id="inpPdf"
          />

          <label class="form-label mt-3">Subir imágenes (opcional)</label>
          <input
            type="file"
            name="imagenes"
            accept="image/*"
            multiple
            class="form-control"
            id="inpImgs"
          />

          <div class="form-text mt-2">
            Puedes subir un PDF y/o varias imágenes. Abajo verás lo que vas a
            enviar.
          </div>

          <!-- ✅ Preview -->
          <div class="mt-3">
            <div class="fw-semibold mb-2">Archivos por subir</div>

            <div id="previewEmpty" class="text-muted small">
              No has seleccionado archivos aún.
            </div>

            <div id="previewPdfWrap" class="d-none mb-2">
              <div class="small text-muted mb-1">PDF</div>
              <ul class="list-group" id="previewPdfList"></ul>
            </div>

            <div id="previewImgsWrap" class="d-none">
              <div class="small text-muted mb-1">Imágenes</div>
              <div class="d-flex flex-wrap gap-2" id="previewImgsGrid"></div>
            </div>
          </div>

          <button class="btn btn-primary mt-3" type="submit">
            <i class="bi bi-upload"></i> Guardar planificación
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const inpPdf = document.getElementById("inpPdf");
    const inpImgs = document.getElementById("inpImgs");

    const previewEmpty = document.getElementById("previewEmpty");
    const previewPdfWrap = document.getElementById("previewPdfWrap");
    const previewPdfList = document.getElementById("previewPdfList");

    const previewImgsWrap = document.getElementById("previewImgsWrap");
    const previewImgsGrid = document.getElementById("previewImgsGrid");

    if (!inpPdf || !inpImgs) return;

    let pdfFile = null;
    let imgFiles = [];

    function humanSize(bytes) {
      if (!bytes && bytes !== 0) return "";
      const mb = bytes / 1024 / 1024;
      if (mb >= 1) return `${mb.toFixed(2)} MB`;
      const kb = bytes / 1024;
      return `${kb.toFixed(0)} KB`;
    }

    function syncInputs() {
      const dtPdf = new DataTransfer();
      if (pdfFile) dtPdf.items.add(pdfFile);
      inpPdf.files = dtPdf.files;

      const dtImgs = new DataTransfer();
      imgFiles.forEach((f) => dtImgs.items.add(f));
      inpImgs.files = dtImgs.files;
    }

    function render() {
      const hasPdf = !!pdfFile;
      const hasImgs = imgFiles.length > 0;

      previewEmpty.classList.toggle("d-none", hasPdf || hasImgs);

      previewPdfWrap.classList.toggle("d-none", !hasPdf);
      previewPdfList.innerHTML = "";
      if (hasPdf) {
        const li = document.createElement("li");
        li.className =
          "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${pdfFile.name}</div>
            <div class="small text-muted">${humanSize(pdfFile.size)}</div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" id="btnDelPdf">
            <i class="bi bi-trash"></i>
          </button>
        `;
        previewPdfList.appendChild(li);

        li.querySelector("#btnDelPdf").addEventListener("click", () => {
          pdfFile = null;
          syncInputs();
          render();
        });
      }

      previewImgsWrap.classList.toggle("d-none", !hasImgs);
      previewImgsGrid.innerHTML = "";
      if (hasImgs) {
        imgFiles.forEach((f, idx) => {
          const card = document.createElement("div");
          card.className = "border rounded p-2";
          card.style.width = "130px";

          const url = URL.createObjectURL(f);
          card.innerHTML = `
            <img src="${url}" alt="${f.name}"
                 style="width:100%;height:90px;object-fit:cover;border-radius:6px;">
            <div class="small mt-1 text-truncate" title="${f.name}">${
            f.name
          }</div>
            <div class="small text-muted">${humanSize(f.size)}</div>
            <button type="button" class="btn btn-sm btn-outline-danger w-100 mt-1">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          `;

          card.querySelector("button").addEventListener("click", () => {
            imgFiles.splice(idx, 1);
            syncInputs();
            render();
          });

          previewImgsGrid.appendChild(card);
        });
      }
    }

    inpPdf.addEventListener("change", () => {
      pdfFile = inpPdf.files && inpPdf.files[0] ? inpPdf.files[0] : null;
      syncInputs();
      render();
    });

    inpImgs.addEventListener("change", () => {
      imgFiles = Array.from(inpImgs.files || []);
      syncInputs();
      render();
    });

    render();
  })();

  (function () {
    const canvas = document.getElementById("chartMedidas");
    if (!canvas) return; // si no hay mediciones, no existe el canvas

    if (typeof Chart === "undefined") {
      console.error("Chart.js no cargó (Chart undefined).");
      return;
    }

    // Leer JSON seguro desde el script type=application/json
    const payloadEl = document.getElementById("chartMedidasPayload");
    let payload = { labels: [], peso: [], grasa: [], musculo: [] };

    if (payloadEl && payloadEl.textContent) {
      try {
        payload = JSON.parse(payloadEl.textContent);
      } catch (e) {
        console.error("chart_json inválido:", e);
      }
    }

    // Construir chart
    new Chart(canvas, {
      type: "line",
      data: {
        labels: payload.labels || [],
        datasets: [
          { label: "Peso (kg)", data: payload.peso || [], tension: 0.3 },
          { label: "% Grasa", data: payload.grasa || [], tension: 0.3 },
          { label: "% Músculo", data: payload.musculo || [], tension: 0.3 },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: false } },
      },
    });
  })();
</script>

{% endblock %}
