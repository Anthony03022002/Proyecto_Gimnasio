{% extends "base_admin.html" %}
{% block title %}Admin - Publicidad{% endblock %}

{% block header %}
<header
  class="h-20 bg-surface-dark/50 backdrop-blur-md px-5 md:px-8 flex items-center justify-between sticky top-0 z-10 border-b border-white/5"
>
  <div class="flex items-center gap-3">
    <button
      type="button"
      class="md:hidden p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
      onclick="openDrawer()"
      aria-label="Abrir menú"
    >
      <span class="material-symbols-outlined">menu</span>
    </button>

    <div>
      <h2 class="text-xl md:text-2xl font-bold text-white">Publicidad</h2>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
{% set active="admin_publicidad" %}

<div class="p-6 md:p-8 max-w-6xl mx-auto space-y-8">

  {# =========================
     FORM
     ========================= #}
  <section>
    <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
      <div class="p-6">
        <form
          method="post"
          action="{{ url_for('web.admin_publicidad_subir') }}"
          enctype="multipart/form-data"
          class="grid grid-cols-1 md:grid-cols-2 gap-8"
        >

          {# Columna izquierda #}
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1.5 text-[rgba(255,255,255,0.6)]">
                Título de la publicidad
              </label>

              <input
                type="text"
                name="titulo"
                placeholder="Ej: Promoción del mes"
                class="w-full rounded-lg px-4 py-2.5 outline-none transition-all
                       bg-[rgba(255,255,255,0.05)]
                       border border-[rgba(255,255,255,0.07)]
                       text-[rgba(255,255,255,0.92)]
                       placeholder:text-[rgba(255,255,255,0.45)]
                       focus:ring-2 focus:ring-[#B8860B] focus:border-[#B8860B]"
              >
            </div>

            <div class="flex items-end">
              <button
                class="w-full bg-[#B8860B] hover:opacity-90 text-white font-semibold py-3 px-6 rounded-lg transition-all
                       flex items-center justify-center gap-2 shadow-lg shadow-[#B8860B]/20"
                type="submit"
              >
                Subir Publicidad
              </button>
            </div>

            {# ✅ Info del archivo elegido #}
            <div id="fileMetaBox" class="hidden rounded-xl border border-[rgba(255,255,255,0.08)] bg-[rgba(255,255,255,0.03)] p-4">
              <div class="flex items-start gap-4">
                <div id="filePreviewWrap" class="hidden w-20 h-16 rounded-lg overflow-hidden border border-[rgba(255,255,255,0.08)] bg-black/20"></div>

                <div class="min-w-0 flex-1">
                  <p class="text-sm font-semibold text-[rgba(255,255,255,0.92)] truncate" id="fileName">—</p>
                  <p class="text-xs text-[rgba(255,255,255,0.55)] mt-1" id="fileInfo">—</p>
                  <p class="text-xs text-[rgba(255,255,255,0.45)] mt-1" id="fileHint">Listo para subir.</p>
                </div>

                <button
                  type="button"
                  id="btnClearFile"
                  class="shrink-0 p-2 rounded-lg transition-colors
                         text-[rgba(255,255,255,0.6)]
                         hover:text-red-300 hover:bg-red-500/10
                         border border-[rgba(255,255,255,0.06)]"
                  title="Quitar archivo"
                >
                  <span class="material-icons-round text-lg">Eliminar</span>
                </button>
              </div>
            </div>

          </div>

          {# Columna derecha #}
          <div>
            <label class="block text-sm font-medium mb-1.5 text-[rgba(255,255,255,0.6)]">
              Archivo (Imagen / Video / PDF)
            </label>

            <div class="relative group">
              <div class="border-2 border-dashed border-[rgba(255,255,255,0.07)] group-hover:border-[#B8860B]
                          transition-colors rounded-xl p-8 flex flex-col items-center justify-center space-y-4
                          bg-[rgba(255,255,255,0.02)]">

                <div class="text-center">
                  <p class="text-sm font-medium text-[rgba(255,255,255,0.92)]">
                    Haz clic para subir o arrastra un archivo
                  </p>
                  <p class="text-xs mt-1 text-[rgba(255,255,255,0.45)]">
                    Formatos soportados: JPG, PNG, MP4, PDF
                  </p>
                </div>

                {# ✅ le ponemos ID para leerlo en JS #}
                <input
                  id="archivoInput"
                  type="file"
                  name="archivo"
                  accept="image/*,video/*,application/pdf"
                  required
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                >
              </div>
            </div>

            <p class="mt-2 text-xs text-[rgba(255,255,255,0.6)]">
              Imágenes se optimizan automáticamente. Videos se recomprimen si hay FFmpeg (Linux producción).
            </p>
          </div>

        </form>
      </div>
    </div>
  </section>

  {# =========================
     LISTADO
     ========================= #}
  <section>
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold tracking-tight text-[rgba(255,255,255,0.92)]">Listado de Publicidades</h3>

      <span class="px-3 py-1 rounded-full text-xs font-semibold
                   bg-[rgba(35,37,39,0.92)]
                   border border-[rgba(255,255,255,0.06)]
                   text-[rgba(255,255,255,0.6)]">
        {% if pubs %}{{ pubs|length }} Publicidades en total{% else %}0 Publicidades en total{% endif %}
      </span>
    </div>

    <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">

          <thead>
            <tr class="text-xs font-semibold uppercase tracking-wider
                       bg-[rgba(255,255,255,0.05)]
                       text-[rgba(255,255,255,0.6)]">
              <th class="px-6 py-4">Vista</th>
              <th class="px-6 py-4">Título / Archivo</th>
              <th class="px-6 py-4 text-right">Acciones</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-[rgba(255,255,255,0.07)]">
            {% if pubs %}
              {% for p in pubs %}
                {% set kind = p.get('kind') %}
                {% set activo = p.get('activo') %}
                {% set titulo = p.get('titulo') %}
                {% set filename = p.get('filename') %}
                {% set bytes_ = p.get('bytes') %}

                <tr class="transition-colors hover:bg-[rgba(255,255,255,0.04)] odd:bg-[rgba(255,255,255,0.02)]">

                  <td class="px-6 py-4">
                    <div class="w-16 h-12 rounded-lg overflow-hidden relative
                                bg-[rgba(255,255,255,0.02)]
                                border border-[rgba(255,255,255,0.06)]">
                      {% if kind == "video" %}
                        <video
                          src="{{ url_for('web.ver_publicidad_media', pub_id=p._id) }}"
                          class="w-full h-full object-cover"
                          muted playsinline preload="metadata"
                        ></video>
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center">
                          <span class="material-icons-round text-white text-lg">play_circle</span>
                        </div>
                      {% elif kind == "pdf" %}
                        <a
                          href="{{ url_for('web.ver_publicidad_media', pub_id=p._id) }}"
                          target="_blank"
                          class="w-full h-full flex items-center justify-center"
                          title="Ver PDF"
                        >
                          <span class="material-icons-round text-red-400">picture_as_pdf</span>
                        </a>
                      {% else %}
                        <img
                          src="{{ url_for('web.ver_publicidad_media', pub_id=p._id) }}"
                          class="w-full h-full object-cover"
                          alt="publicidad"
                        >
                      {% endif %}
                    </div>
                  </td>

                  <td class="px-6 py-4">
                    <p class="text-sm font-semibold text-[rgba(255,255,255,0.92)]">
                      {% if titulo %}{{ titulo }}{% else %}Publicidad{% endif %}
                    </p>
                    <p class="text-xs mt-0.5 text-[rgba(255,255,255,0.45)]">
                      {{ filename }}
                      {% if bytes_ %}({{ (bytes_ / 1024 / 1024) | round(2) }} MB){% endif %}
                      {% if kind %} · <span class="uppercase">{{ kind }}</span>{% endif %}
                    </p>
                  </td>

                  <td class="px-6 py-4 text-right">
                    <div class="flex items-center justify-end gap-3">

                      {# ✅ Toggle (un solo endpoint) #}
                      <form method="post" action="{{ url_for('web.admin_publicidad_toggle', pub_id=p._id) }}" class="inline">
                        <button
                          type="submit"
                          class="group inline-flex items-center gap-2 px-3 py-2 rounded-xl transition-colors
                                 border border-[rgba(255,255,255,0.08)]
                                 hover:bg-[rgba(255,255,255,0.04)]
                                 text-[rgba(255,255,255,0.75)]"
                          title="{% if activo %}Desactivar{% else %}Activar{% endif %}"
                        >
                          <span class="relative inline-flex items-center">
                            {% if activo %}
                              <span class="w-11 h-6 rounded-full bg-[#B8860B]"></span>
                              <span class="absolute top-[2px] left-[2px] h-5 w-5 rounded-full bg-white transition-all translate-x-full"></span>
                            {% else %}
                              <span class="w-11 h-6 rounded-full bg-[rgba(255,255,255,0.10)]"></span>
                              <span class="absolute top-[2px] left-[2px] h-5 w-5 rounded-full bg-white transition-all"></span>
                            {% endif %}
                          </span>

                          <span class="text-xs font-semibold">
                            {% if activo %}Desactivar{% else %}Activar{% endif %}
                          </span>
                        </button>
                      </form>

                      {# ✅ Eliminar #}
                      <form
                        method="post"
                        action="{{ url_for('web.admin_publicidad_eliminar', pub_id=p._id) }}"
                        class="inline"
                        onsubmit="return confirm('¿Eliminar esta publicidad? Esta acción no se puede deshacer.')"
                      >
                        <button
                          type="submit"
                          class="p-2 rounded-xl transition-colors
                                 text-[rgba(255,255,255,0.70)]
                                 hover:text-red-300 hover:bg-red-500/10
                                 border border-[rgba(255,255,255,0.08)]"
                          title="Eliminar"
                        >
                          <span class="material-icons-round text-lg">Eliminar</span>
                        </button>
                      </form>

                    </div>
                  </td>

                </tr>
              {% endfor %}

              <tr>
                <td class="px-6 py-4 text-center" colspan="4">
                  <p class="text-xs text-[rgba(255,255,255,0.45)] py-2">
                    Solo puede haber una publicidad activa a la vez.
                  </p>
                </td>
              </tr>

            {% else %}
              <tr>
                <td colspan="4" class="px-6 py-10 text-center text-[rgba(255,255,255,0.45)]">
                  Aún no has subido publicidades.
                </td>
              </tr>
            {% endif %}
          </tbody>

        </table>
      </div>
    </div>
  </section>

</div>

{# ✅ Script preview archivo #}
<script>
  (function () {
    const input = document.getElementById("archivoInput");
    const metaBox = document.getElementById("fileMetaBox");
    const fileName = document.getElementById("fileName");
    const fileInfo = document.getElementById("fileInfo");
    const fileHint = document.getElementById("fileHint");
    const previewWrap = document.getElementById("filePreviewWrap");
    const btnClear = document.getElementById("btnClearFile");

    if (!input || !metaBox) return;

    function humanSize(bytes) {
      const b = Number(bytes || 0);
      if (!b) return "0 B";
      const units = ["B","KB","MB","GB"];
      let i = 0, v = b;
      while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
      return v.toFixed(i === 0 ? 0 : 2) + " " + units[i];
    }

    function clearPreview() {
      input.value = "";
      metaBox.classList.add("hidden");
      if (previewWrap) {
        previewWrap.innerHTML = "";
        previewWrap.classList.add("hidden");
      }
    }

    function setPreview(file) {
      metaBox.classList.remove("hidden");
      fileName.textContent = file.name || "archivo";
      fileInfo.textContent = `${file.type || "tipo desconocido"} · ${humanSize(file.size)}`;

      // reset preview
      if (previewWrap) {
        previewWrap.innerHTML = "";
        previewWrap.classList.add("hidden");
      }

      // preview image/video
      const type = (file.type || "").toLowerCase();
      if (previewWrap && (type.startsWith("image/") || type.startsWith("video/"))) {
        const url = URL.createObjectURL(file);
        previewWrap.classList.remove("hidden");

        if (type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = url;
          img.className = "w-full h-full object-cover";
          img.onload = () => URL.revokeObjectURL(url);
          previewWrap.appendChild(img);
          fileHint.textContent = "Imagen cargada. Listo para subir.";
        } else {
          const vid = document.createElement("video");
          vid.src = url;
          vid.muted = true;
          vid.playsInline = true;
          vid.preload = "metadata";
          vid.className = "w-full h-full object-cover";
          vid.onloadedmetadata = () => URL.revokeObjectURL(url);
          previewWrap.appendChild(vid);
          fileHint.textContent = "Video cargado. Listo para subir.";
        }
      } else if ((file.type || "").toLowerCase().includes("pdf")) {
        fileHint.textContent = "PDF cargado. Listo para subir.";
      } else {
        fileHint.textContent = "Archivo cargado. Listo para subir.";
      }
    }

    input.addEventListener("change", () => {
      const f = input.files && input.files[0];
      if (!f) return clearPreview();
      setPreview(f);
    });

    if (btnClear) btnClear.addEventListener("click", clearPreview);
  })();
</script>

{% endblock %}
