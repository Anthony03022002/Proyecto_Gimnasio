{% extends "base.html" %}
{% block title %}Admin - Horarios{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Configurar horarios por día</h4>
  <a href="{{ url_for('web.horarios_publico') }}" class="btn btn-sm btn-outline-secondary">
    Ver horarios públicos
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" action="{{ url_for('web.admin_horarios_semana_post') }}">

      <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <label class="form-label">Intervalo</label>
          <select name="slot_minutes" class="form-select">
            <option value="60" {% if cfg.slot_minutes==60 %}selected{% endif %}>60 min</option>
            <option value="30" {% if cfg.slot_minutes==30 %}selected{% endif %}>30 min</option>
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Cupo máximo</label>
          <input type="number" min="1" name="cupo_maximo" class="form-control" value="{{ cfg.cupo_maximo or 10 }}" required>
        </div>
      </div>

      <hr class="my-3"/>

      {% set days = [
        ("mon","Lunes"),("tue","Martes"),("wed","Miércoles"),
        ("thu","Jueves"),("fri","Viernes"),("sat","Sábado"),("sun","Domingo")
      ] %}

      <div class="row g-3">
        {% for key, label in days %}
          {% set d = cfg.days.get(key, {}) %}
          {% set enabled = d.get("enabled", False) %}
          {% set b0 = (d.get("bloques") or [{}]) %}
          {% set b1 = (d.get("bloques") or [{},{}]) %}
          {% set bloque1 = (d.get("bloques")[0] if d.get("bloques") and d.get("bloques")|length > 0 else {"ini":"05:00","fin":"12:00"}) %}
          {% set bloque2 = (d.get("bloques")[1] if d.get("bloques") and d.get("bloques")|length > 1 else {"ini":"15:00","fin":"22:00"}) %}

          <div class="col-12">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                  <input class="form-check-input day-toggle"
                         type="checkbox"
                         id="day_{{ key }}"
                         name="day_enabled_{{ key }}"
                         {% if enabled %}checked{% endif %}>
                  <label class="form-check-label fw-semibold" for="day_{{ key }}">
                    {{ label }}
                  </label>
                </div>

                <span class="small text-muted">2 bloques</span>
              </div>

              <div class="day-panel mt-3 {% if not enabled %}d-none{% endif %}" data-day="{{ key }}">
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <div class="small text-muted mb-1">Bloque 1</div>
                    <div class="row g-2">
                      <div class="col-6">
                        <input type="time" class="form-control"
                               name="{{ key }}_b1_ini" value="{{ bloque1.ini or '05:00' }}">
                      </div>
                      <div class="col-6">
                        <input type="time" class="form-control"
                               name="{{ key }}_b1_fin" value="{{ bloque1.fin or '12:00' }}">
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-6">
                    <div class="small text-muted mb-1">Bloque 2</div>
                    <div class="row g-2">
                      <div class="col-6">
                        <input type="time" class="form-control"
                               name="{{ key }}_b2_ini" value="{{ bloque2.ini or '15:00' }}">
                      </div>
                      <div class="col-6">
                        <input type="time" class="form-control"
                               name="{{ key }}_b2_fin" value="{{ bloque2.fin or '22:00' }}">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-text mt-2">
                  Si no quieres un bloque, déjalo vacío (luego validamos).
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-primary">
          Guardar configuración semanal
        </button>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
  document.querySelectorAll(".day-toggle").forEach(cb => {
    cb.addEventListener("change", () => {
      const key = cb.id.replace("day_", "");
      const panel = document.querySelector(`.day-panel[data-day="${key}"]`);
      if (!panel) return;
      panel.classList.toggle("d-none", !cb.checked);
    });
  });
})();
</script>

{% endblock %}
