{% extends "base_admin.html" %}
{% block title %}Renovar suscripción{% endblock %}

{% block header %}
<header class="h-20 bg-surface-dark/50 backdrop-blur-md px-5 md:px-8 flex items-center justify-between sticky top-0 z-10 border-b border-white/5">
  <div class="flex items-center gap-3">
    <button
      type="button"
      class="md:hidden p-2 rounded-lg hover:bg-white/5 text-secondary hover:text-white transition-colors"
      onclick="openDrawer()"
      aria-label="Abrir menú"
    >
      <span class="material-symbols-outlined">menu</span>
    </button>

    <div>
      <h2 class="text-xl md:text-2xl font-bold text-white">Renovar Suscripción</h2>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}

{% set active = "cajero_renovar" %}

{# ✅ Estilos “tipo admin” (igual a tus pantallas oscuras) #}
<div class="max-w-6xl mx-auto px-6 md:px-8 py-6 space-y-6">

  {# Buscar #}
  <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
    <div class="p-6 border-b border-[rgba(255,255,255,0.07)]">
      <h3 class="text-lg font-bold text-[rgba(255,255,255,0.92)]">Buscar cliente</h3>
    </div>
    <div class="p-6">
      <form method="get" action="{{ url_for('web.cajero_renovar') }}" class="grid grid-cols-1 md:grid-cols-12 gap-3">
        <div class="md:col-span-9">
          <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Buscar</label>
          <input
            class="mt-1 w-full px-4 py-2.5 rounded-xl
                   bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                   text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                   outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
            name="q"
            value="{{ q }}"
            placeholder="Nombre, cédula, teléfono o email"
          >
        </div>

        <div class="md:col-span-3 flex items-end">
          <button
            class="w-full px-4 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10
                   text-sm font-semibold text-white transition-colors inline-flex items-center justify-center gap-2"
            type="submit"
          >
            <span class="material-symbols-outlined text-sm">search</span>
            Buscar
          </button>
        </div>
      </form>
    </div>
  </div>

  {# Resultados #}
  {% if clientes %}
    <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
      <div class="p-6 border-b border-[rgba(255,255,255,0.07)] flex items-center justify-between">
        <h3 class="text-lg font-bold text-[rgba(255,255,255,0.92)]">Resultados</h3>
        <span class="text-xs font-semibold text-[rgba(255,255,255,0.45)]">{{ clientes|length }} cliente(s)</span>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-[rgba(255,255,255,0.05)]">
            <tr>
              <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Identificación</th>
              <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider">Teléfono</th>
              <th class="px-6 py-4 text-xs font-bold text-accent uppercase tracking-wider text-right">Acción</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[rgba(255,255,255,0.07)]">
            {% for c in clientes %}
              <tr class="transition-colors hover:bg-[rgba(255,255,255,0.04)] odd:bg-[rgba(255,255,255,0.02)]">
                <td class="px-6 py-4">
                  <div class="text-sm font-semibold text-[rgba(255,255,255,0.92)]">{{ c.nombre or '-' }}</div>
                  {% if c.email %}
                    <div class="text-xs text-[rgba(255,255,255,0.45)] mt-1">{{ c.email }}</div>
                  {% endif %}
                </td>
                <td class="px-6 py-4 text-sm text-[rgba(255,255,255,0.6)]">{{ c.identificacion or '-' }}</td>
                <td class="px-6 py-4 text-sm text-[rgba(255,255,255,0.6)]">{{ c.telefono or '-' }}</td>
                <td class="px-6 py-4 text-right">
                  <a
                    class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg
                           bg-accent hover:bg-accent/90 text-sm font-semibold text-white transition-colors"
                    href="{{ url_for('web.cajero_renovar', cliente_id=c._id) }}"
                  >
                    Seleccionar
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# Cliente seleccionado #}
  {% if cliente %}
    <div class="bg-[rgba(35,37,39,0.92)] border border-[rgba(255,255,255,0.06)] rounded-2xl shadow-sm overflow-hidden">
      <div class="p-6 border-b border-[rgba(255,255,255,0.07)] flex items-center justify-between gap-3">
        <h3 class="text-lg font-bold text-[rgba(255,255,255,0.92)]">Cliente seleccionado</h3>
        <span class="text-sm text-[rgba(255,255,255,0.6)]">{{ cliente.nombre }}</span>
      </div>

      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          {# Estado #}
          <div class="rounded-2xl border border-[rgba(255,255,255,0.06)] bg-[rgba(255,255,255,0.02)] p-5">
            <div class="text-sm font-semibold text-[rgba(255,255,255,0.92)]">Estado membresía</div>

            <div class="mt-3">
              {% if estado == "Activa" %}
                <span class="inline-flex items-center gap-2 text-[11px] font-bold text-green-300 bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20">
                  ACTIVA
                </span>
                <div class="text-xs text-[rgba(255,255,255,0.45)] mt-2">Días restantes: {{ dias_restantes }}</div>
              {% elif estado == "Vencida" %}
                <span class="inline-flex items-center gap-2 text-[11px] font-bold text-red-300 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">
                  VENCIDA
                </span>
              {% else %}
                <span class="inline-flex items-center gap-2 text-[11px] font-bold text-[rgba(255,255,255,0.6)] bg-white/5 px-3 py-1 rounded-full border border-white/10">
                  SIN MEMBRESÍA
                </span>
              {% endif %}
            </div>
          </div>

          {# Form renovar #}
          <form method="post" action="{{ url_for('web.cajero_renovar_post') }}"
                class="rounded-2xl border border-[rgba(255,255,255,0.06)] bg-[rgba(255,255,255,0.02)] p-5 space-y-4">
            <input type="hidden" name="cliente_id" value="{{ cliente._id }}">

            <div>
              <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Meses</label>
              <select name="meses" id="meses"
                      class="mt-1 w-full px-4 py-2.5 rounded-xl
                             bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                             text-[rgba(255,255,255,0.92)] outline-none
                             focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                      required>
                <option class="text-black" value="1" {% if meses_default==1 %}selected{% endif %}>1 mes</option>
                <option class="text-black" value="3">3 meses</option>
                <option class="text-black" value="6">6 meses</option>
                <option class="text-black" value="12">12 meses</option>
              </select>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Fecha inicio</label>
                <input type="date"
                       name="fecha_inicio"
                       id="fecha_inicio"
                       class="mt-1 w-full px-4 py-2.5 rounded-xl
                              bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                              text-[rgba(255,255,255,0.92)] outline-none
                              focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                       value="{{ inicio_default.isoformat() }}">
              </div>

              <div>
                <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Fecha fin</label>
                <input type="date"
                       name="fecha_fin"
                       id="fecha_fin"
                       class="mt-1 w-full px-4 py-2.5 rounded-xl
                              bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                              text-[rgba(255,255,255,0.92)] outline-none
                              focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                       value="{{ fin_default.isoformat() }}">
              </div>
            </div>

            <div>
              <label class="text-xs font-semibold text-[rgba(255,255,255,0.6)]">Concepto</label>
              <input
                type="text"
                name="concepto"
                class="mt-1 w-full px-4 py-2.5 rounded-xl
                       bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)]
                       text-[rgba(255,255,255,0.92)] placeholder:text-[rgba(255,255,255,0.45)]
                       outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60 transition"
                placeholder="Ej: Renovación enero / Promoción / Cambio de plan"
                maxlength="120"
              >
              <div class="text-[11px] text-[rgba(255,255,255,0.45)] mt-1">Opcional. Se guardará en la venta.</div>
            </div>

            <button class="w-full px-4 py-2.5 rounded-xl bg-accent hover:bg-accent/90
                           text-sm font-semibold text-white transition-colors inline-flex items-center justify-center gap-2"
                    type="submit">
              <span class="material-symbols-outlined text-sm">autorenew</span>
              Renovar
            </button>
          </form>

        </div>
      </div>
    </div>
  {% endif %}

</div>

<script>
(function () {
  const mesesSel = document.getElementById("meses");
  const iniInp   = document.getElementById("fecha_inicio");
  const finInp   = document.getElementById("fecha_fin");

  if (!mesesSel || !iniInp || !finInp) return;

  function pad2(n){ return String(n).padStart(2, "0"); }

  function parseISODate(s){
    if(!s) return null;
    const [y,m,d] = s.split("-").map(Number);
    if(!y || !m || !d) return null;
    return { y, m, d };
  }

  function lastDayOfMonth(y, m){
    return new Date(y, m, 0).getDate();
  }

  function addMonthsISO(iso, months){
    const p = parseISODate(iso);
    if(!p) return "";
    let y = p.y;
    let m = p.m;
    const d = p.d;

    let total = (m - 1) + months;
    y = y + Math.floor(total / 12);
    m = (total % 12) + 1;

    const last = lastDayOfMonth(y, m);
    const day = Math.min(d, last);

    return `${y}-${pad2(m)}-${pad2(day)}`;
  }

  function recalc(){
    const meses = parseInt(mesesSel.value || "0", 10) || 0;
    const ini = iniInp.value;
    if(!ini || meses <= 0){
      finInp.value = "";
      return;
    }
    finInp.value = addMonthsISO(ini, meses);
  }

  mesesSel.addEventListener("change", recalc);
  iniInp.addEventListener("change", recalc);
  recalc();
})();
</script>

{% endblock %}
