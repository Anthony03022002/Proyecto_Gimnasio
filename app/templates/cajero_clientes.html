{% extends "base.html" %} {% block title %}Mis clientes{% endblock %} {% block
content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Clientes</h4>
    <div class="text-muted small">Clientes relacionados a tus ventas</div>
  </div>
  <a
    class="btn btn-sm btn-outline-primary"
    href="{{ url_for('web.facturacion_nueva') }}"
  >
    <i class="bi bi-plus-lg"></i> Nueva venta
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Nombre</th>
            <th>Usuario</th>
            <th>Teléfono</th>
            <th>Estado</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if clientes %} {% for c in clientes %}
          <tr>
            <td class="fw-semibold">{{ c.nombre }}</td>
            <td class="text-muted">{{ c.username }}</td>
            <td>{{ c.telefono or '-' }}</td>
            <td>
              {% if c.user_activo %}
                <span class="badge bg-success">Activo</span>
              {% else %}
                <span class="badge bg-danger">Inactivo</span>
              {% endif %}
            </td>


            <td class="text-end">
              <a
                class="btn btn-sm btn-outline-primary"
                href="{{ url_for('web.cajero_cliente_editar', cliente_id=c._id) }}"
              >
                <i class="bi bi-pencil"></i>
              </a>

              <!-- ✅ botón fuera de forms -->
              <button
                type="button"
                class="btn btn-sm btn-outline-dark"
                data-bs-toggle="modal"
                data-bs-target="#modalPwd{{ c._id }}"
                title="Cambiar contraseña"
              >
                <i class="bi bi-key"></i>
              </button>
            </td>
          </tr>

          <!-- ✅ MODAL: dentro del for (c existe) -->
          <div
            class="modal fade"
            id="modalPwd{{ c._id }}"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="bi bi-key me-1"></i> Cambiar contraseña
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>

                <form
                  method="post"
                  action="{{ url_for('web.cajero_cliente_password', cliente_id=c._id) }}"
                >
                  <div class="modal-body">
                    <div class="mb-2">
                      <div class="small text-muted">Cliente:</div>
                      <div class="fw-semibold">
                        {{ c.nombre }}
                        <span class="text-muted">({{ c.username }})</span>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Nueva contraseña</label>
                      <input
                        class="form-control"
                        type="password"
                        name="new_password"
                        minlength="6"
                        required
                      />
                      <div class="form-text">Mínimo 6 caracteres.</div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Confirmar</label>
                      <input
                        class="form-control"
                        type="password"
                        name="confirm_password"
                        minlength="6"
                        required
                      />
                    </div>

                    <div class="alert alert-warning mb-0">
                      <i class="bi bi-exclamation-triangle me-1"></i>
                      Al cliente se le pedirá cambiar la contraseña al iniciar
                      sesión.
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                      Guardar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {% endfor %} {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-3">
              Aún no tienes clientes (haz una venta para registrar).
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
