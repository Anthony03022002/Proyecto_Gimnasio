{% extends "base.html" %}
{% block title %}Admin - Ventas{% endblock %}
{% block content %}

{% set active = "admin_ventas" %}

<div class="row g-3">

  {# CONTENIDO PRINCIPAL #}
  <div class="col-12 col-lg-9 mb-3">

    {# Header móvil con botón menú #}
    <div class="d-lg-none mb-3 d-flex justify-content-between align-items-center">
      <h3 class="mb-0">Ventas</h3>
      <button
        class="btn btn-outline-primary btn-sm"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#adminMenuOffcanvas"
        aria-controls="adminMenuOffcanvas"
      >
        <i class="bi bi-list"></i> Menú
      </button>
    </div>

    {# Header desktop #}
    <div class="d-none d-lg-block">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="mb-0">Ventas</h3>
        <a href="{{ url_for('web.admin_dashboard') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left"></i> Volver al dashboard
        </a>
      </div>
    </div>

    <p class="text-muted mb-3">Listado de ventas con filtros.</p>

    <div class="card shadow-sm">

      <div class="card-header">
        <div class="d-flex flex-column flex-md-row gap-2 justify-content-between align-items-md-center">
          <span class="fw-semibold">Todas las ventas</span>
          <span class="text-muted small">
            {% if total is defined %}{{ total }} registros{% endif %}
          </span>
        </div>
      </div>

      {# ✅ FILTROS #}
      <div class="p-3 border-bottom">
        <form class="row g-2" method="get" action="{{ url_for('web.admin_ventas_listado') }}">
          <div class="col-12 col-md-6">
            <label class="form-label small text-muted mb-1">Cliente (nombre / apellido / identificación)</label>
            <input
              class="form-control"
              name="q"
              placeholder="Ej: Anthony, Guamán, 1753..."
              value="{{ q or '' }}"
            >
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label small text-muted mb-1">Desde</label>
            <input type="date" class="form-control" name="desde" value="{{ desde or '' }}">
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label small text-muted mb-1">Hasta</label>
            <input type="date" class="form-control" name="hasta" value="{{ hasta or '' }}">
          </div>

          <div class="col-12 d-flex justify-content-end gap-2 mt-1">
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('web.admin_ventas_listado') }}">
              <i class="bi bi-x-circle"></i> Limpiar
            </a>
            <button class="btn btn-outline-primary btn-sm" type="submit">
              <i class="bi bi-funnel"></i> Filtrar
            </button>
          </div>
        </form>
      </div>

      {# ✅ TABLA #}
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Identificación</th>
                <th>Teléfono</th>
                <th>Vendedor</th>
                <th class="text-end">Meses</th>
                <th>Desde</th>
                <th>Hasta</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% if ventas %}
                {% for v in ventas %}
                <tr>
                  <td>
                    {% if v.fecha %}
                      {{ v.fecha.strftime('%d/%m/%Y') }}
                    {% else %}-{% endif %}
                  </td>

                  <td>
                    {{ v.cliente_nombre or '-' }} {{ v.cliente_apellido or '' }}
                  </td>

                  <td>
                    {{ v.cliente_identificacion or '-' }}
                  </td>

                  <td>
                    {{ v.cliente_telefono or '-' }}
                  </td>

                  <td>
                    {{ v.vendedor or '-' }}
                  </td>

                  <td class="text-end">
                    {% if v.membresia and v.membresia.meses is not none %}
                      {{ v.membresia.meses }}
                    {% else %}-{% endif %}
                  </td>

                  <td>
                    {% if v.membresia and v.membresia.fecha_desde %}
                      {{ v.membresia.fecha_desde.strftime('%d/%m/%Y') }}
                    {% else %}-{% endif %}
                  </td>

                  <td>
                    {% if v.membresia and v.membresia.fecha_hasta %}
                      {{ v.membresia.fecha_hasta.strftime('%d/%m/%Y') }}
                    {% else %}-{% endif %}
                  </td>

                  <td class="text-end">
                    {# ✅ EDITAR con MODAL #}
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary btn-edit-venta"
                      data-bs-toggle="modal"
                      data-bs-target="#modalEditarVenta"

                      data-id="{{ v._id }}"
                      data-fecha="{{ v.fecha.strftime('%Y-%m-%d') if v.fecha else '' }}"
                      data-vendedor="{{ v.vendedor or '' }}"
                      data-ident="{{ v.cliente_identificacion or '' }}"
                      data-cliente="{{ (v.cliente_nombre or '') ~ ' ' ~ (v.cliente_apellido or '') }}"

                      data-meses="{% if v.membresia and v.membresia.meses is not none %}{{ v.membresia.meses }}{% endif %}"
                      data-desde="{{ v.membresia.fecha_desde.strftime('%Y-%m-%d') if v.membresia and v.membresia.fecha_desde else '' }}"
                      data-hasta="{{ v.membresia.fecha_hasta.strftime('%Y-%m-%d') if v.membresia and v.membresia.fecha_hasta else '' }}"
                      title="Editar"
                    >
                      <i class="bi bi-pencil"></i>
                    </button>

                    {# ✅ ELIMINAR #}
                    <form class="d-inline"
                          method="post"
                          action="{{ url_for('web.admin_venta_delete', venta_id=v._id) }}"
                          onsubmit="return confirm('¿Eliminar esta venta?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit" title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>

                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="9" class="text-center text-muted py-3">
                    No hay ventas con esos filtros.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="px-3 py-2 text-muted small d-flex justify-content-between align-items-center">
          <span>Mostrando 20 por página (más recientes primero).</span>
          {% if page is defined and total_pages is defined %}
            <span>Página {{ page }} de {{ total_pages }}</span>
          {% endif %}
        </div>

        {# ✅ PAGINACIÓN #}
        {% if total_pages is defined and total_pages > 1 %}
        <div class="p-3 pt-0">
          <nav aria-label="Paginación ventas">
            <ul class="pagination pagination-sm mb-0 justify-content-end">

              <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('web.admin_ventas_listado', page=page-1, q=q, desde=desde, hasta=hasta) }}">
                  Anterior
                </a>
              </li>

              {% set start_p = page - 2 %}
              {% set end_p = page + 2 %}
              {% if start_p < 1 %}{% set start_p = 1 %}{% endif %}
              {% if end_p > total_pages %}{% set end_p = total_pages %}{% endif %}

              {% for p in range(start_p, end_p + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                  <a class="page-link"
                     href="{{ url_for('web.admin_ventas_listado', page=p, q=q, desde=desde, hasta=hasta) }}">
                    {{ p }}
                  </a>
                </li>
              {% endfor %}

              <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('web.admin_ventas_listado', page=page+1, q=q, desde=desde, hasta=hasta) }}">
                  Siguiente
                </a>
              </li>

            </ul>
          </nav>
        </div>
        {% endif %}

      </div>
    </div>
  </div>

  {# SIDEBAR (DESKTOP) #}
  <div class="d-none d-lg-block col-lg-3">
    {% include "partials/sidebar_admin.html" %}
  </div>

</div>

{# OFFCANVAS (MÓVIL) #}
<div
  class="offcanvas offcanvas-end"
  tabindex="-1"
  id="adminMenuOffcanvas"
  aria-labelledby="adminMenuOffcanvasLabel"
>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="adminMenuOffcanvasLabel">Menú</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body">
    {% include "partials/sidebar_admin.html" %}
  </div>
</div>

{# ===========================
   ✅ MODAL EDITAR VENTA
   =========================== #}
<div class="modal fade" id="modalEditarVenta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" id="formEditarVenta">
        <div class="modal-header">
          <div>
            <h5 class="modal-title mb-0">Editar venta</h5>
            <div class="text-muted small" id="txtVentaCliente">Cliente: -</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">

            <div class="col-12 col-md-4">
              <label class="form-label">Fecha (venta)</label>
              <input type="date" class="form-control" name="fecha" id="inpFecha">
              <div class="form-text">Si lo dejas vacío, no cambia.</div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Vendedor (cajero)</label>
              <select class="form-select" name="vendedor" id="selVendedor">
                <option value="">-- Selecciona --</option>
                {% for c in cajeros %}
                  <option value="{{ c.username }}">{{ c.username }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Identificación cliente</label>
              <input type="text" class="form-control" name="cliente_identificacion" id="inpIdent" required>
              <div class="form-text">Cambiar esto reasigna la venta a otro cliente.</div>
            </div>

            <hr class="my-2">

            <div class="col-12 col-md-4">
              <label class="form-label">Meses</label>
              <input type="number" min="0" class="form-control" name="meses" id="inpMeses">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Desde</label>
              <input type="date" class="form-control" name="fecha_desde" id="inpDesde">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Hasta</label>
              <input type="date" class="form-control" name="fecha_hasta" id="inpHasta">
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-save"></i> Guardar cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // plantilla de URL para POST editar
  const editUrlTemplate = "{{ url_for('web.admin_venta_edit_post', venta_id='__VID__') }}";

  const modal = document.getElementById('modalEditarVenta');
  modal.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    if (!btn) return;

    const id = btn.getAttribute('data-id') || '';
    const fecha = btn.getAttribute('data-fecha') || '';
    const vendedor = btn.getAttribute('data-vendedor') || '';
    const ident = btn.getAttribute('data-ident') || '';
    const clienteTxt = btn.getAttribute('data-cliente') || '-';
    const meses = btn.getAttribute('data-meses') || '';
    const desde = btn.getAttribute('data-desde') || '';
    const hasta = btn.getAttribute('data-hasta') || '';

    // set action
    const form = document.getElementById('formEditarVenta');
    form.action = editUrlTemplate.replace('__VID__', id);

    // fill inputs
    document.getElementById('txtVentaCliente').textContent = 'Cliente: ' + clienteTxt;
    document.getElementById('inpFecha').value = fecha;
    document.getElementById('inpIdent').value = ident;
    document.getElementById('inpMeses').value = meses;
    document.getElementById('inpDesde').value = desde;
    document.getElementById('inpHasta').value = hasta;

    // select vendedor
    const sel = document.getElementById('selVendedor');
    sel.value = vendedor;
  });
</script>

{% endblock %}
