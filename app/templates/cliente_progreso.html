{% extends "base_cliente.html" %}

{% block content %}

{# =========================
   VARIABLES (Jinja)
   ========================= #}
{% set nombre_cliente = ((cliente.nombre or '') ~ ' ' ~ (cliente.apellido or ''))|trim
  if cliente else (session.get('username') or 'Cliente') %}

<style>
  /* Solo afecta a ESTA pantalla */
  .glass-panel{
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(212,175,55,0.1);
  }
  .gold-gradient-text{
    background: linear-gradient(to right, #D4AF37, #F7EF8A, #B87333);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .copper-gold-btn{
    background: linear-gradient(135deg, #B87333 0%, #D4AF37 100%);
    transition: all 0.3s ease;
  }
  .copper-gold-btn:hover{
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 20px rgba(184,115,51,0.4);
  }
  .dotted-border{
    background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuDXakBRStyaC3MT_BvQu9Yuh-R24bg4r_uKIq6dK8axPIqChNqzyCTt1jCz0kjzipP9IhExZ58Ljxm9SosHz5ZTGEr0nuSCJ9sko3Rf99ZaC_eU618QpE5BcC-02Eyg4CiIgSFPKUlPq7vJ-D_F87eJugN3737cDCDJcpsFAutNmrxyaPHCruGGDRTqWztmZyXN2QzkQ4ynjwlxxYh6kk7y2oAR8jyZpF7Y_c1knxytAp_hmG5iSf8ox8ZzJkHPOmtJnokop8nTTuOo);
    border-radius: 1rem;
  }
  .kpi-card::after{
    content:"";
    position:absolute;
    bottom:0; left:0;
    width:100%; height:2px;
    background: linear-gradient(to right, transparent, #D4AF37, transparent);
  }
  .elite-file{
    position:absolute;
    inset:0;
    opacity:0;
    cursor:pointer;
  }
</style>

<div class="max-w-7xl mx-auto">

  {# =========================
     TITLE + BACK
     ========================= #}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    {# =========================
       LEFT (KPI + PLAN)
       ========================= #}
    <div class="lg:col-span-2 space-y-8">

      {# ---------- KPI ---------- #}
      <section class="glass-panel p-8 rounded-2xl relative overflow-hidden">

        <div class="flex justify-between items-center mb-10">
          <div class="flex items-center gap-4">
            <span class="material-symbols-outlined text-primary text-3xl">analytics</span>
            <div>
              <h2 class="text-xl font-display tracking-widest uppercase text-white">
                Indicadores <span class="text-primary font-sans italic text-base">(KPI)</span>
              </h2>
              <p class="text-xs text-white/40 uppercase tracking-widest">Métricas de composición corporal</p>
            </div>
          </div>

          {% if kpi_latest and kpi_latest.creado %}
            <div class="text-xs font-mono text-primary/50">
              Última actualización: {{ kpi_latest.creado.strftime('%d/%m/%Y') }}
            </div>
          {% else %}
            <div class="text-xs font-mono text-primary/50">Última actualización: —</div>
          {% endif %}
        </div>

        {% if kpi_latest %}
          {# ✅ valores seguros #}
          {% set peso_now  = (kpi_latest.peso_kg if kpi_latest.peso_kg is not none else 0) %}
          {% set grasa_now = (kpi_latest.grasa_pct if kpi_latest.grasa_pct is not none else 0) %}
          {% set musc_now  = (kpi_latest.musculo_pct if kpi_latest.musculo_pct is not none else 0) %}

          {% set peso_prev  = (kpi_prev.peso_kg if kpi_prev and kpi_prev.peso_kg is not none else none) %}
          {% set grasa_prev = (kpi_prev.grasa_pct if kpi_prev and kpi_prev.grasa_pct is not none else none) %}
          {% set musc_prev  = (kpi_prev.musculo_pct if kpi_prev and kpi_prev.musculo_pct is not none else none) %}

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="kpi-card relative p-6 bg-white/5 rounded-xl border border-white/5 group hover:border-primary/20 transition-all duration-500">
              <p class="text-[10px] uppercase tracking-[0.2em] text-white/40 mb-1">Peso Actual</p>
              <div class="flex items-baseline gap-2">
                <span class="text-4xl font-light text-white group-hover:gold-gradient-text transition-all">
                  {{ "%.1f"|format(peso_now|float) }}
                </span>
                <span class="text-sm text-primary/60">kg</span>
              </div>
              {% if peso_prev is not none %}
                <div class="mt-2 text-xs text-white/40">
                  Δ {{ "%.1f"|format((peso_now|float - peso_prev|float)) }} kg
                </div>
              {% endif %}
              <div class="mt-4 h-[2px] w-full bg-white/5 overflow-hidden">
                <div class="h-full bg-primary/40 w-full transition-all duration-1000"></div>
              </div>
            </div>

            <div class="kpi-card relative p-6 bg-white/5 rounded-xl border border-white/5 group hover:border-primary/20 transition-all duration-500">
              <p class="text-[10px] uppercase tracking-[0.2em] text-white/40 mb-1">Grasa Corporal</p>
              <div class="flex items-baseline gap-2">
                <span class="text-4xl font-light text-white group-hover:gold-gradient-text transition-all">
                  {{ "%.1f"|format(grasa_now|float) }}
                </span>
                <span class="text-sm text-primary/60">%</span>
              </div>
              {% if grasa_prev is not none %}
                <div class="mt-2 text-xs text-white/40">
                  Δ {{ "%.1f"|format((grasa_now|float - grasa_prev|float)) }}%
                </div>
              {% endif %}
              <div class="mt-4 h-[2px] w-full bg-white/5 overflow-hidden">
                <div class="h-full bg-primary/40 w-full transition-all duration-1000"></div>
              </div>
            </div>

            <div class="kpi-card relative p-6 bg-white/5 rounded-xl border border-white/5 group hover:border-primary/20 transition-all duration-500">
              <p class="text-[10px] uppercase tracking-[0.2em] text-white/40 mb-1">% Músculo</p>
              <div class="flex items-baseline gap-2">
                <span class="text-4xl font-light text-white group-hover:gold-gradient-text transition-all">
                  {{ "%.1f"|format(musc_now|float) }}
                </span>
                <span class="text-sm text-primary/60">%</span>
              </div>
              {% if musc_prev is not none %}
                <div class="mt-2 text-xs text-white/40">
                  Δ {{ "%.1f"|format((musc_now|float - musc_prev|float)) }}%
                </div>
              {% endif %}
              <div class="mt-4 h-[2px] w-full bg-white/5 overflow-hidden">
                <div class="h-full bg-primary/40 w-full transition-all duration-1000"></div>
              </div>
            </div>

          </div>

          <div class="mt-8 p-5 rounded-xl border border-white/10 bg-white/5">
            <canvas id="chartMedidas" height="120"></canvas>
            <script id="chartMedidasPayload" type="application/json">
              {{ chart_json|default('{"labels":[],"peso":[],"grasa":[],"musculo":[]}')|safe }}
            </script>
          </div>

        {% else %}
          <div class="mt-10 flex items-center justify-center p-8 border border-white/5 bg-white/5 rounded-xl">
            <p class="text-sm text-white/40 italic font-serif">
              "La constancia es la llave del templo del éxito. Aún no hay mediciones registradas por tu entrenador."
            </p>
          </div>
        {% endif %}
      </section>

      {# ---------- PLANIFICACIÓN ---------- #}
      <section class="relative rounded-2xl overflow-hidden min-h-[300px] group">
        <img alt="Elite Gym Training"
             class="absolute inset-0 w-full h-full object-cover scale-105 group-hover:scale-100 transition-transform duration-700 brightness-50 opacity-40"
             src="https://lh3.googleusercontent.com/aida-public/AB6AXuDcWio7cam3ysQKx8otKZ5yLVzmhd9IHA1m8E_cU_DIuhDWMmCb-VYMQSS2BpkpZdOmKn47ZxL53OQOwiSu6cGxjFyp3ul4i5Li9qclTx5_Pt_qq9LLwAmvAZHSS_mxPe9qNzgFj-iGAXf5KOV38nqOCEDesvHfpx7huzSOEa0s-T6H7AsvCE_m6m47Ij3Y5Fmu9WGGrq4CYpTZDCEe2gT6QZ83jHnQ_2_GNyi4S7JseDfy662ycKPOt2cpUFh6Yk7QxmEukM3p14av"/>
        <div class="absolute inset-0 bg-gradient-to-t from-obsidian via-obsidian/40 to-transparent"></div>

        <div class="relative p-10 h-full flex flex-col justify-between">
          <div>
            <div class="flex items-center gap-4 mb-4">
              <span class="material-symbols-outlined text-primary text-3xl">fitness_center</span>
              <h2 class="text-xl font-display tracking-widest uppercase text-white">Planificación Elite</h2>
            </div>
            <p class="max-w-md text-white/60 leading-relaxed font-light">
              Accede a tu programa personalizado de alto rendimiento diseñado meticulosamente para tus objetivos únicos.
            </p>
          </div>

          <div class="mt-12">
            {% if plan_actual %}
              <div class="flex flex-col gap-3 max-w-2xl">
                <div class="flex items-center gap-4 py-6 px-8 glass-panel rounded-xl border-white/10">
                  <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary">description</span>
                  </div>

                  <div class="flex-1">
                    <p class="text-sm font-medium">Planificación actual</p>
                    <p class="text-xs text-white/40 uppercase tracking-widest">
                      {% if plan_actual.filename or plan_actual.rel_path %}
                        {{ plan_actual.filename }}
                        {% if plan_actual.bytes %}
                          · {{ (plan_actual.bytes/1024/1024)|round(2) }} MB
                        {% endif %}
                      {% else %}
                        Sin PDF
                      {% endif %}
                    </p>

                    {% set dt = plan_actual.updated_at or plan_actual.creado %}
                    {% if dt %}
                      <p class="text-xs text-white/40 mt-1">Actualizada: {{ dt.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                  </div>

                  {% if plan_actual.filename or plan_actual.rel_path %}
                    <a href="{{ url_for('web.descargar_planificacion', plan_id=plan_actual._id) }}"
                       class="copper-gold-btn px-6 py-3 rounded-xl text-white font-bold uppercase tracking-[0.2em] text-xs shadow-lg shadow-copper/20 inline-flex items-center gap-2">
                      <span class="material-symbols-outlined text-lg">download</span>
                      Descargar
                    </a>
                  {% endif %}
                </div>

                {% if plan_actual.images and plan_actual.images|length > 0 %}
                  <div class="flex flex-wrap gap-2">
                    {% for img in plan_actual.images %}
                      <a class="border border-white/10 rounded-xl p-1 bg-white/5"
                         href="{{ url_for('web.ver_plan_imagen', plan_id=plan_actual._id, idx=loop.index0) }}"
                         target="_blank" title="{{ img.filename }}">
                        <img
                          src="{{ url_for('web.ver_plan_imagen', plan_id=plan_actual._id, idx=loop.index0) }}"
                          alt="{{ img.filename }}"
                          style="width:90px;height:90px;object-fit:cover;border-radius:10px;"
                          loading="lazy"
                        />
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="flex items-center gap-4 py-6 px-8 glass-panel rounded-xl border-white/10 max-w-lg">
                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                  <span class="material-symbols-outlined text-primary">lock</span>
                </div>
                <div>
                  <p class="text-sm font-medium">Contenido Pendiente</p>
                  <p class="text-xs text-white/40 uppercase tracking-widest">
                    Aún no tienes una planificación subida por tu entrenador.
                  </p>
                </div>
              </div>
            {% endif %}
          </div>

        </div>
      </section>

    </div>

    {# =========================
       RIGHT (GALERÍA)
       ========================= #}
    <div class="space-y-8">
      <section class="glass-panel p-8 rounded-2xl h-full flex flex-col">
        <div class="mb-8">
          <div class="flex items-center gap-4 mb-2">
            <span class="material-symbols-outlined text-primary">photo_library</span>
            <h2 class="text-xl font-display tracking-widest uppercase text-white">Galería</h2>
          </div>
          <p class="text-xs text-white/40 uppercase tracking-widest">Inmortaliza tu evolución física</p>
        </div>

        <div class="flex-1 flex flex-col">

          <form method="post"
                action="{{ url_for('web.cliente_progreso_subir_foto') }}"
                enctype="multipart/form-data">

            <label class="dotted-border p-1 text-center group cursor-pointer hover:bg-white/5 transition-all mb-6 block relative">
              <div class="py-12 px-4 rounded-2xl flex flex-col items-center">
                <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-500">
                  <span class="material-symbols-outlined text-primary text-3xl">cloud_upload</span>
                </div>
                <h3 class="text-white font-medium mb-1">Elegir Archivos</h3>
                <p class="text-xs text-white/40 max-w-[220px] leading-relaxed">
                  Arrastra tus fotos aquí o haz clic para buscarlas.
                </p>
                <p class="mt-4 text-[10px] text-primary/60 uppercase tracking-widest">Máximo 4 fotos por subida</p>
              </div>

              <input id="inpFotos" type="file" name="foto" accept="image/*" class="elite-file" required multiple>
            </label>

            <div class="space-y-4">
              <div class="p-4 bg-white/5 rounded-xl border border-white/10 flex items-center justify-between">
                <span id="txtFiles" class="text-xs text-white/40 italic">Sin archivos seleccionados</span>
                <span class="text-[10px] font-mono text-primary/40 uppercase">Ready</span>
              </div>

              <button type="submit"
                      class="copper-gold-btn w-full py-4 rounded-xl flex items-center justify-center gap-3 text-white font-bold uppercase tracking-[0.2em] text-xs shadow-lg shadow-copper/20">
                <span class="material-symbols-outlined text-lg">publish</span>
                Subir Foto
              </button>

              <p class="text-[11px] text-white/35">
                La imagen se optimiza automáticamente para ocupar menos espacio.
              </p>
            </div>
          </form>

          <div class="mt-12 pt-8 border-t border-white/5">
            <div class="flex items-center justify-between mb-6">
              <span class="text-[10px] uppercase tracking-widest text-white/40">Tu Historial</span>
            </div>

            {% if fotos and fotos|length > 0 %}
              <div class="grid grid-cols-2 gap-3">
                {% for img in fotos %}
                  <div class="rounded-xl overflow-hidden border border-white/10 bg-white/5">
                    <a href="{{ url_for('web.cliente_progreso_ver_foto', foto_id=img._id) }}" target="_blank">
                      <img
                        src="{{ url_for('web.cliente_progreso_ver_foto', foto_id=img._id) }}"
                        alt="foto progreso"
                        loading="lazy"
                        class="w-full h-[140px] object-cover"
                      />
                    </a>

                    <div class="p-3">
                      <div class="text-xs text-white/45 mb-3">
                        {% if img.creado %}{{ img.creado.strftime('%d/%m/%Y') }}{% endif %}
                        {% if img.bytes %} · {{ (img.bytes/1024/1024)|round(2) }} MB{% endif %}
                      </div>

                      <form method="post"
                            action="{{ url_for('web.cliente_progreso_eliminar_foto', foto_id=img._id) }}"
                            onsubmit="return confirm('¿Eliminar esta foto?');">
                        <button type="submit"
                                class="w-full py-2 rounded-lg border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-white text-[10px] uppercase tracking-[0.2em] font-bold">
                          Eliminar
                        </button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-12 px-6">
                <div class="opacity-10 mb-4 flex justify-center">
                  <span class="material-symbols-outlined text-6xl">no_photography</span>
                </div>
                <p class="text-sm text-white/30 italic font-serif">
                  "Aún no has subido fotos a tu galería privada."
                </p>
              </div>
            {% endif %}
          </div>

        </div>
      </section>
    </div>

  </div>
</div>

{% endblock %}

{# ============================================================
   SCRIPTS (si tu base_cliente.html tiene block scripts, úsalo)
   Si NO lo tiene, mueve este bloque dentro del block content.
   ============================================================ #}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const canvas = document.getElementById("chartMedidas");
    if (!canvas) return;

    if (typeof Chart === "undefined") {
      console.error("Chart.js no cargó (Chart undefined).");
      return;
    }

    const payloadEl = document.getElementById("chartMedidasPayload");
    let payload = { labels: [], peso: [], grasa: [], musculo: [] };

    if (payloadEl && payloadEl.textContent) {
      try { payload = JSON.parse(payloadEl.textContent); }
      catch (e) { console.error("chart_json inválido:", e); }
    }

    Chart.defaults.color = "rgba(255,255,255,0.70)";
    Chart.defaults.borderColor = "rgba(255,255,255,0.10)";

    new Chart(canvas, {
      type: "line",
      data: {
        labels: payload.labels || [],
        datasets: [
          { label: "Peso (kg)", data: payload.peso || [], tension: 0.35 },
          { label: "% Grasa", data: payload.grasa || [], tension: 0.35 },
          { label: "% Músculo", data: payload.musculo || [], tension: 0.35 }
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { grid: { color: "rgba(255,255,255,0.06)" } },
          y: { beginAtZero: false, grid: { color: "rgba(255,255,255,0.06)" } }
        }
      }
    });
  })();

  (function () {
    const inp = document.getElementById("inpFotos");
    const txt = document.getElementById("txtFiles");
    if (!inp) return;

    inp.addEventListener("change", () => {
      const files = Array.from(inp.files || []);
      if (files.length > 4) {
        alert("Máximo 4 fotos por subida.");
        inp.value = "";
        if (txt) txt.textContent = "Sin archivos seleccionados";
        return;
      }
      if (txt) txt.textContent = files.length ? (files.length + " archivo(s) seleccionado(s)") : "Sin archivos seleccionados";
    });
  })();
</script>
{% endblock %}
