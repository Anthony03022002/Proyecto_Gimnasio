{% extends "base.html" %}
{% block title %}Mi Progreso{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Mi progreso</h4>
    <div class="text-muted small">Planificación, KPIs y galería de fotos</div>
  </div>

  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('web.cliente_dashboard') }}">
    ← Volver
  </a>
</div>

{# =========================
   ✅ KPI + HISTORIAL MEDIDAS
   ========================= #}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h6 class="card-subtitle mb-0 text-muted">Indicadores (KPI)</h6>
        <div class="text-muted small">Peso, % grasa y % músculo</div>
      </div>
    </div>

    {% if kpi_latest %}

      {# ✅ valores seguros (evita None/string) #}
      {% set peso_now = (kpi_latest.peso_kg if kpi_latest and kpi_latest.peso_kg is not none else 0) %}
      {% set grasa_now = (kpi_latest.grasa_pct if kpi_latest and kpi_latest.grasa_pct is not none else 0) %}
      {% set musc_now = (kpi_latest.musculo_pct if kpi_latest and kpi_latest.musculo_pct is not none else 0) %}

      {% set peso_prev = (kpi_prev.peso_kg if kpi_prev and kpi_prev.peso_kg is not none else none) %}
      {% set grasa_prev = (kpi_prev.grasa_pct if kpi_prev and kpi_prev.grasa_pct is not none else none) %}
      {% set musc_prev = (kpi_prev.musculo_pct if kpi_prev and kpi_prev.musculo_pct is not none else none) %}

      <div class="row g-2 mt-3">
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
              <div class="text-muted small">Peso</div>
              <div class="fs-4 fw-semibold">{{ "%.1f"|format(peso_now|float) }} kg</div>
              {% if peso_prev is not none %}
                <div class="small text-muted">
                  Δ {{ "%.1f"|format((peso_now|float - peso_prev|float)) }} kg
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
              <div class="text-muted small">% Grasa</div>
              <div class="fs-4 fw-semibold">{{ "%.1f"|format(grasa_now|float) }}%</div>
              {% if grasa_prev is not none %}
                <div class="small text-muted">
                  Δ {{ "%.1f"|format((grasa_now|float - grasa_prev|float)) }}%
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
              <div class="text-muted small">% Músculo</div>
              <div class="fs-4 fw-semibold">{{ "%.1f"|format(musc_now|float) }}%</div>
              {% if musc_prev is not none %}
                <div class="small text-muted">
                  Δ {{ "%.1f"|format((musc_now|float - musc_prev|float)) }}%
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <canvas id="chartMedidas" height="120"></canvas>
      </div>

      {# ✅ payload seguro siempre #}
      <script id="chartMedidasPayload" type="application/json">
        {{ chart_json|default('{"labels":[],"peso":[],"grasa":[],"musculo":[]}')|safe }}
      </script>

    {% else %}
      <div class="text-muted small mt-3">Aún no hay mediciones registradas por tu entrenador.</div>
    {% endif %}
  </div>
</div>

{# =========================
   ✅ PLANIFICACIÓN (PDF)
   ========================= #}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h6 class="card-subtitle mb-2 text-muted">Planificación</h6>

    {% if plan_actual %}
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <div class="fw-semibold">Planificación actual</div>

          <div class="text-muted small">
            {# ✅ NO mostrar "plan.pdf" si no existe realmente #}
            {% if plan_actual.filename or plan_actual.rel_path %}
              {{ plan_actual.filename }}
              {% if plan_actual.bytes %}
                · {{ (plan_actual.bytes / 1024 / 1024) | round(2) }} MB
              {% endif %}
            {% else %}
              <span class="text-muted">Sin PDF</span>
            {% endif %}
          </div>

          <div class="text-muted small mt-1">
            {% set dt = plan_actual.updated_at or plan_actual.creado %}
            {% if dt %}
              Actualizada: {{ dt.strftime('%d/%m/%Y %H:%M') }}
            {% endif %}
          </div>
        </div>

        {# ✅ botón descargar SOLO si existe PDF #}
        {% if plan_actual.filename or plan_actual.rel_path %}
          <a class="btn btn-sm btn-primary"
             href="{{ url_for('web.descargar_planificacion', plan_id=plan_actual._id) }}">
            <i class="bi bi-download"></i> Descargar
          </a>
        {% endif %}
      </div>

      {# ✅ IMÁGENES DE LA PLANIFICACIÓN (subidas por entrenador) #}
      {% if plan_actual.images and plan_actual.images|length > 0 %}
        <hr class="my-3">
        <div class="fw-semibold mb-2">Fotos de la planificación</div>
        <div class="d-flex flex-wrap gap-2">
          {% for img in plan_actual.images %}
            <a class="border rounded p-1 d-inline-block"
               href="{{ url_for('web.ver_plan_imagen', plan_id=plan_actual._id, idx=loop.index0) }}"
               target="_blank" title="{{ img.filename }}">
              <img
                src="{{ url_for('web.ver_plan_imagen', plan_id=plan_actual._id, idx=loop.index0) }}"
                alt="{{ img.filename }}"
                style="width:90px;height:90px;object-fit:cover;border-radius:6px;"
                loading="lazy"
              >
            </a>
          {% endfor %}
        </div>
      {% endif %}

    {% else %}
      <div class="text-muted">
        Aún no tienes una planificación subida por tu entrenador.
      </div>
    {% endif %}
  </div>
</div>

{# =========================
   ✅ GALERÍA DE PROGRESO
   ========================= #}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h6 class="card-subtitle mb-0 text-muted">Galería de progreso</h6>
        <div class="text-muted small">Sube fotos y guarda tu avance</div>
      </div>
    </div>

    <form method="post"
          action="{{ url_for('web.cliente_progreso_subir_foto') }}"
          enctype="multipart/form-data"
          class="row g-2 align-items-end">
      <div class="col-12 col-md-8">
        <label class="form-label mb-1">Subir foto</label>
        <input type="file" name="foto" accept="image/*" class="form-control" required multiple>
        <div class="form-text">Máximo 4 fotos por subida.</div>
        <div class="form-text">
          La imagen se optimiza automáticamente para ocupar menos espacio.
        </div>
      </div>
      <div class="col-12 col-md-4 d-grid">
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-upload"></i> Subir foto
        </button>
      </div>
    </form>
  </div>
</div>

{% if fotos and fotos|length > 0 %}
  <div class="row g-3">
    {% for img in fotos %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card shadow-sm h-100">
          <a href="{{ url_for('web.cliente_progreso_ver_foto', foto_id=img._id) }}"
             target="_blank"
             class="text-decoration-none">
            <img
              src="{{ url_for('web.cliente_progreso_ver_foto', foto_id=img._id) }}"
              class="card-img-top"
              style="height: 180px; object-fit: cover;"
              alt="foto progreso"
              loading="lazy"
            >
          </a>
          <div class="card-body p-2">
          <div class="small text-muted mb-2">
            {% if img.creado %}{{ img.creado.strftime('%d/%m/%Y') }}{% endif %}
            {% if img.bytes %} · {{ (img.bytes/1024/1024)|round(2) }} MB{% endif %}
          </div>

          <form method="post"
                action="{{ url_for('web.cliente_progreso_eliminar_foto', foto_id=img._id) }}"
                onsubmit="return confirm('¿Eliminar esta foto?');">
            <button class="btn btn-sm btn-outline-danger w-100" type="submit">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </form>
        </div>

        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-muted small">
    Aún no has subido fotos.
  </div>
{% endif %}

{# =========================
   ✅ JS (abajo) para Chart
   ========================= #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const canvas = document.getElementById("chartMedidas");
    if (!canvas) return; // si no hay mediciones, no existe el canvas

    if (typeof Chart === "undefined") {
      console.error("Chart.js no cargó (Chart undefined).");
      return;
    }

    const payloadEl = document.getElementById("chartMedidasPayload");
    let payload = { labels: [], peso: [], grasa: [], musculo: [] };

    if (payloadEl && payloadEl.textContent) {
      try {
        payload = JSON.parse(payloadEl.textContent);
      } catch (e) {
        console.error("chart_json inválido:", e);
      }
    }

    new Chart(canvas, {
      type: "line",
      data: {
        labels: payload.labels || [],
        datasets: [
          { label: "Peso (kg)", data: payload.peso || [], tension: 0.3 },
          { label: "% Grasa", data: payload.grasa || [], tension: 0.3 },
          { label: "% Músculo", data: payload.musculo || [], tension: 0.3 }
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: false } }
      }
    });
  })();

  (function () {
    const inp = document.querySelector('input[name="foto"]');
    if (!inp) return;

    inp.addEventListener("change", () => {
      const files = Array.from(inp.files || []);
      if (files.length > 4) {
        alert("Máximo 4 fotos por subida.");
        inp.value = ""; // limpia selección
      }
    });
  })();
</script>

{% endblock %}
